<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>03-脚手架核心流程开发 | 今日前端</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?4ef6dc604509807e9702b3851e114a74";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
      </script>
      </script>
    <script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1183508160150958" crossorigin="anonymous"></script>
    <meta name="description" content="脚手架核心流程开发">
    
    <link rel="preload" href="/assets/css/0.styles.ab222855.css" as="style"><link rel="preload" href="/assets/js/app.4690e35c.js" as="script"><link rel="preload" href="/assets/js/2.505fbce2.js" as="script"><link rel="preload" href="/assets/js/1.8644e8ec.js" as="script"><link rel="preload" href="/assets/js/67.ab2beac7.js" as="script"><link rel="prefetch" href="/assets/js/10.cab30127.js"><link rel="prefetch" href="/assets/js/11.dd4acf6f.js"><link rel="prefetch" href="/assets/js/12.30378d2b.js"><link rel="prefetch" href="/assets/js/13.52db13dd.js"><link rel="prefetch" href="/assets/js/14.b1e55c9a.js"><link rel="prefetch" href="/assets/js/15.397321e8.js"><link rel="prefetch" href="/assets/js/16.41ea9dc0.js"><link rel="prefetch" href="/assets/js/17.ae9bd38c.js"><link rel="prefetch" href="/assets/js/18.7f05db4f.js"><link rel="prefetch" href="/assets/js/19.e7419ed2.js"><link rel="prefetch" href="/assets/js/20.5de11ad9.js"><link rel="prefetch" href="/assets/js/21.d1e22ea1.js"><link rel="prefetch" href="/assets/js/22.72ada26c.js"><link rel="prefetch" href="/assets/js/23.c0a0b2d8.js"><link rel="prefetch" href="/assets/js/24.3e816b8b.js"><link rel="prefetch" href="/assets/js/25.3f733c03.js"><link rel="prefetch" href="/assets/js/26.db25a028.js"><link rel="prefetch" href="/assets/js/27.15ed1846.js"><link rel="prefetch" href="/assets/js/28.208ac68e.js"><link rel="prefetch" href="/assets/js/29.69d9bd33.js"><link rel="prefetch" href="/assets/js/3.7a4ab8e5.js"><link rel="prefetch" href="/assets/js/30.f039addb.js"><link rel="prefetch" href="/assets/js/31.b9fd445b.js"><link rel="prefetch" href="/assets/js/32.899591cb.js"><link rel="prefetch" href="/assets/js/33.f3808942.js"><link rel="prefetch" href="/assets/js/34.1c51bd04.js"><link rel="prefetch" href="/assets/js/35.5dec34de.js"><link rel="prefetch" href="/assets/js/36.08add187.js"><link rel="prefetch" href="/assets/js/37.5feb420b.js"><link rel="prefetch" href="/assets/js/38.afefe479.js"><link rel="prefetch" href="/assets/js/39.c9cdfded.js"><link rel="prefetch" href="/assets/js/4.0aef8d22.js"><link rel="prefetch" href="/assets/js/40.96b04497.js"><link rel="prefetch" href="/assets/js/41.04859dc6.js"><link rel="prefetch" href="/assets/js/42.3881136d.js"><link rel="prefetch" href="/assets/js/43.d142a153.js"><link rel="prefetch" href="/assets/js/44.5cb88048.js"><link rel="prefetch" href="/assets/js/45.3541cd11.js"><link rel="prefetch" href="/assets/js/46.e6c88c3b.js"><link rel="prefetch" href="/assets/js/47.3f992b97.js"><link rel="prefetch" href="/assets/js/48.5996b4fc.js"><link rel="prefetch" href="/assets/js/49.fea4d36b.js"><link rel="prefetch" href="/assets/js/5.baaddd77.js"><link rel="prefetch" href="/assets/js/50.4cd3422c.js"><link rel="prefetch" href="/assets/js/51.228fffda.js"><link rel="prefetch" href="/assets/js/52.92861e6c.js"><link rel="prefetch" href="/assets/js/53.b72d8ce0.js"><link rel="prefetch" href="/assets/js/54.c15c9cdc.js"><link rel="prefetch" href="/assets/js/55.9bc4f52b.js"><link rel="prefetch" href="/assets/js/56.947ab898.js"><link rel="prefetch" href="/assets/js/57.fa37cf58.js"><link rel="prefetch" href="/assets/js/58.d682c2a2.js"><link rel="prefetch" href="/assets/js/59.4499ef43.js"><link rel="prefetch" href="/assets/js/6.f5ab8614.js"><link rel="prefetch" href="/assets/js/60.aa57de27.js"><link rel="prefetch" href="/assets/js/61.5049d857.js"><link rel="prefetch" href="/assets/js/62.ec9a8087.js"><link rel="prefetch" href="/assets/js/63.38b9610d.js"><link rel="prefetch" href="/assets/js/64.0034d3be.js"><link rel="prefetch" href="/assets/js/65.5a44c8b1.js"><link rel="prefetch" href="/assets/js/66.ad0a55cb.js"><link rel="prefetch" href="/assets/js/68.fa3c4346.js"><link rel="prefetch" href="/assets/js/69.4c304a67.js"><link rel="prefetch" href="/assets/js/7.62e43543.js"><link rel="prefetch" href="/assets/js/70.9965b915.js"><link rel="prefetch" href="/assets/js/71.f5f8e219.js"><link rel="prefetch" href="/assets/js/72.afe95f75.js"><link rel="prefetch" href="/assets/js/73.55da3950.js"><link rel="prefetch" href="/assets/js/74.860ada40.js"><link rel="prefetch" href="/assets/js/75.66a003ea.js"><link rel="prefetch" href="/assets/js/76.886902cd.js"><link rel="prefetch" href="/assets/js/77.680b69b8.js"><link rel="prefetch" href="/assets/js/78.6440c559.js"><link rel="prefetch" href="/assets/js/79.4f3af818.js"><link rel="prefetch" href="/assets/js/80.b04f59cc.js"><link rel="prefetch" href="/assets/js/81.d4c4e4b3.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.03d43e08.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ab222855.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.ico" alt="今日前端" class="logo"> <span class="site-name can-hide">今日前端</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/daily/day30.html" class="nav-link">
  今日前端
</a></div><div class="nav-item"><a href="/github/before.html" class="nav-link">
  Github网站食用
</a></div><div class="nav-item"><a href="/web/before.html" class="nav-link">
  前端脚手架
</a></div><div class="nav-item"><a href="https://blog.liugezhou.online" target="_blank" rel="noopener noreferrer" class="nav-link external">
  他的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/liugezhou/daydayup" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/daily/day30.html" class="nav-link">
  今日前端
</a></div><div class="nav-item"><a href="/github/before.html" class="nav-link">
  Github网站食用
</a></div><div class="nav-item"><a href="/web/before.html" class="nav-link">
  前端脚手架
</a></div><div class="nav-item"><a href="https://blog.liugezhou.online" target="_blank" rel="noopener noreferrer" class="nav-link external">
  他的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/liugezhou/daydayup" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/web/before.html" class="sidebar-link">关于</a></li><li><a href="/web/00.html" class="sidebar-link">00-整体架构设计文档范本V0.1</a></li><li><a href="/web/01.html" class="sidebar-link">01-需求分析与架构设计</a></li><li><a href="/web/02.html" class="sidebar-link">02-脚手架架构设计和框架搭建</a></li><li><a href="/web/03.html" aria-current="page" class="active sidebar-link">03-脚手架核心流程开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/03.html#第一章-本周导学" class="sidebar-link">第一章：本周导学</a></li><li class="sidebar-sub-header"><a href="/web/03.html#第二章-脚手架整体架构设计" class="sidebar-link">第二章：脚手架整体架构设计</a></li><li class="sidebar-sub-header"><a href="/web/03.html#第三章-脚手架模块拆分策略和core模块技术方案" class="sidebar-link">第三章 脚手架模块拆分策略和core模块技术方案</a></li><li class="sidebar-sub-header"><a href="/web/03.html#第四章-脚手架执行准备过程实现" class="sidebar-link">第四章：脚手架执行准备过程实现</a></li><li class="sidebar-sub-header"><a href="/web/03.html#第五章-脚手架命令注册实现-基于commander" class="sidebar-link">第五章：脚手架命令注册实现(基于commander）</a></li><li class="sidebar-sub-header"><a href="/web/03.html#第六章-node项目如何支持es-module【加餐】" class="sidebar-link">第六章 Node项目如何支持ES Module【加餐】</a></li></ul></li><li><a href="/web/04.html" class="sidebar-link">04-脚手架命令注册和执行过程开发</a></li><li><a href="/web/05.html" class="sidebar-link">05-脚手架创建项目流程设计和开发</a></li><li><a href="/web/06.html" class="sidebar-link">06-脚手架项目和组件初始化开发</a></li><li><a href="/web/14.html" class="sidebar-link">14-服务端选型：磨刀不如砍柴功</a></li><li><a href="/web/15.html" class="sidebar-link">15-服务端 CI_CD：Github 自动化</a></li><li><a href="/web/16.html" class="sidebar-link">16-编辑器服务端API开发</a></li><li><a href="/web/17.html" class="sidebar-link">17-编辑器服务端调用第三方服务</a></li><li><a href="/web/28.html" class="sidebar-link">28-脚手架发布模块架构设计和核心流程开发</a></li><li><a href="/web/29.html" class="sidebar-link">29-脚手架发布模式git自动化流程开发</a></li><li><a href="/web/30.html" class="sidebar-link">30-脚手架发布模块云构建系统开发</a></li><li><a href="/web/31.html" class="sidebar-link">31-脚手架发布模块云发布功能开发</a></li><li><a href="/web/32.html" class="sidebar-link">32-脚手架组件发布功能开发</a></li><li><a href="/web/33.html" class="sidebar-link">33-组件平台开发</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="第一章-本周导学"><a href="#第一章-本周导学" class="header-anchor">#</a> 第一章：本周导学</h2> <p><strong>本周整体内容介绍和学习方法</strong> <strong>标题</strong>
脚手架需求分析和架构设计，核心流程开发</p> <p><strong>收获</strong></p> <ul><li>架构设计和技术方案设计全过程</li> <li>脚手架核心流程和commander框架</li> <li>如何让Node项目支持ES Module</li></ul> <p><strong>主要内容</strong></p> <ul><li>脚手架需求分析和架构设计</li> <li>脚手架模块拆分策略和core模块技术方案</li> <li>脚手架执行准备过程实现</li> <li>脚手架命令注册实现(基于commander)</li></ul> <p><strong>加餐</strong>
Node项目如何支持ES Module</p> <h2 id="第二章-脚手架整体架构设计"><a href="#第二章-脚手架整体架构设计" class="header-anchor">#</a> 第二章：脚手架整体架构设计</h2> <p><strong>2-1 大厂是如何做项目的</strong> <img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/3-1.6id7710dpwk0.webp" alt="3-1"></p> <p><strong>2-2 前端研发过程中的痛点和需求分析</strong> <img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/3-2.6ic0nprs1e00.webp" alt="3-2"></p> <p><strong>2-3 加餐：大厂的git操作规范是怎样的？</strong></p> <ul><li>clone下来的项目 master分支是不做开发的，我们会新建一个dev分支，上线以后会新建一个release分支。</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/3-3.4sujpjgc1p40.webp" alt="3-3"></p> <p><strong>2-4 高端操作：脚手架架构设计+绘制架构图 /  2-5 架构设计图绘图技巧分享</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/3-4.3xuy7m03daw0.webp" alt="3-4"></p> <h2 id="第三章-脚手架模块拆分策略和core模块技术方案"><a href="#第三章-脚手架模块拆分策略和core模块技术方案" class="header-anchor">#</a> 第三章 脚手架模块拆分策略和core模块技术方案</h2> <p><strong>3-1 脚手架模块拆分策略</strong></p> <ul><li>核心流程：core</li> <li>命令：      commands  【初始化、发布、清除缓存】</li> <li>模型层：   models       【Command命令 、 Project项目 、 Component组件 、 Npm模块 、 Git仓库】</li> <li>支撑模块：utils           【Git操作 、 云构建 、 工具方法 、 API请求、 Git API】</li></ul> <p><strong>3-2 core模块技术方案</strong></p> <p>准备阶段：
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/3-5.1i5lq7mn8h5s.webp" alt="3-5"></p> <h2 id="第四章-脚手架执行准备过程实现"><a href="#第四章-脚手架执行准备过程实现" class="header-anchor">#</a> 第四章：脚手架执行准备过程实现</h2> <p><strong>4-1 脚手架框架代码拆包+import-local应用</strong></p> <ul><li>mkdir cloudscope-cli</li> <li>cd cloudscope-cli</li> <li>npm init -y</li> <li>添加 .gitignore文件</li> <li>lerna init</li> <li>lerna create cli &amp; lerna create utils</li> <li>mkdir  commands &amp; mkdir models &amp; mkdir core  &amp; mkdir utils</li> <li>将packages下core移到外层core、utils移到外层utils,删除packages目录</li> <li>修改lerna.json文件：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;packages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;core/*&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;commands/*&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;models/*&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;utils/*&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.4&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li>在cloudscope-cli/core/cli下新建bin/index.js文件</li> <li>修改  cloudscope-cli/core/cli下的package.json配置文件，添加如下代码</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>……
 <span class="token string-property property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;cloudscope-cli&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bin/index.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
 ……
 <span class="token string-property property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;@cloudscope-cli/utils&quot;</span><span class="token operator">:</span> <span class="token string">&quot;file:../../utils/utils&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;import-local&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.2&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;npmlog&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.1.2&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>cd core/cli</li> <li>npm install</li> <li>在cloudscope-cli/core/cli/bin/index.js下添加如下代码：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token hashbang comment">#! /usr/bin/env node</span>

<span class="token keyword">const</span> importLocal <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'import-local'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">importLocal</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'npmlog'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'cli'</span><span class="token punctuation">,</span><span class="token string">'正在使用 cloudscope-cli 本地版本'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>在cloudscope-cli/core/cli/lib/index.js 文件中添加一行日志文件</li> <li>npm link</li> <li>cloudscope-cli:即可看到输出日志</li></ul> <p>git代码提交扩展
我将此代码通过分支的形式，对每一次的代码提交，都在一个特殊的分支进行代码提交。
本节提交到该分支：<a href="https://github.com/liugezhou/cloudscope-cli/tree/lesson01" target="_blank" rel="noopener noreferrer"> lesson01<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>下面是分支提交小记录。</p> <ul><li><p>git checkout -b lesson01</p></li> <li><p>git add . &amp;&amp; git commit -m 'lesson01 for init ' &amp;&amp; git push origin lesson01</p></li> <li><p>git checkout main</p></li> <li><p>git merge lesson01</p></li> <li><p>git push</p></li> <li><p>删除本地分支  git branch -D lesson01</p></li> <li><p>如果后面我们想要修改该分支代码并提交到该分支，我们就可以：</p></li> <li><p>git checkout -b temp origin/lesson01</p></li></ul> <p><strong>4-2 检查版本号功能开发（require加载资源类型讲解+npmlog封装)</strong></p> <p>从本节开始本地新建分支 lesson02，最后将此分支代码推送至远程仓库<a href="https://github.com/liugezhou/cloudscope-cli" target="_blank" rel="noopener noreferrer">cloudscope-cli<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <ol><li>本节代码开发过程中在命令行用到的命令：</li></ol> <ul><li>utils下新建log包： lerna create @cloudscope-cli/log utils</li> <li>log下安装npmlog包： lerna add npmjs utils/log</li></ul> <ol start="2"><li>其它记录的小知识点</li></ol> <ul><li>require加载资源的类型：</li> <li>.js      ： 必须输出一个module.exports || exports.</li> <li>.json   :  会通过JSON.parse()对该文件进行解析，并输出一个对象</li> <li>.node  ： c++的一个插件，它的实现原理是通过 process.dlopen去打开一个c++插件，通常不使用。</li> <li>any     ：会通过.js引擎进行解析</li></ul> <ol start="3"><li>npmlog源码：</li></ol> <ul><li>default level:  info，可以通过传入的参数进行level定制。</li> <li>源码中存在的 log.addLevel()才可以打印，我们也可以通过这个方法定制自己的打印设置。（可以设置名字、value值大小，字体色、背景色等）</li> <li>可以通过 log.heading定制输日志输出的前置。同时可以通过headingStyle做样式修改。</li></ul> <p><strong>4-3 最低Node版本检查功能开发</strong></p> <p>检查Node版本号的原因以及解决办法：</p> <ul><li>这是因为一些低版本的Node API在低版本是不支持的，因此要设置一个最低的Node版本号。</li> <li>拿到本地版本号的方法为：process.version</li> <li>版本号比对：第三方库 semver。</li> <li>抛出异常颜色输出：第三方库 colors:引用'colors/safe',使用：colors.red('')</li></ul> <p><strong>4-4 root账号启动检查和自动降级功能开发</strong></p> <p>检查账号权限原因以及解决方法：</p> <ul><li>如果是使用root权限，一些文件就没有可读或者修改权限，因此需要对用户进行查询与降级处理</li> <li>通过process.geteuid() 获取登录用户的ID ,501为普通用户，0 为超级管理员(root)</li> <li>检查第三方库：root-check。使用方法引入一下调用即可降级。</li> <li>root-check实现原理：调用downgrade-root 库 -&gt; 判断是否为root权限 -&gt; 若是通过process.env.SUDO_UID或者默认 defaultUid() 获取各个操作系统的uid</li></ul> <p><strong>4-5 用户主目录检查功能开发</strong></p> <ul><li><p>user-home:可以实现跨操作系统获取用户主目录的功能。</p></li> <li><p>path-exists:判断文件目录是否存在</p></li> <li><p>user-home实现：调用os-homedir库，再调用os库，若os库有homedir直接返回，若没有直接拿process.env.home(),还是没有就拼接 ‘/Users/'+process.env.USER</p></li> <li><p>path-exists实现：直接调用fs的accessSync(path)方法。</p></li></ul> <p><strong>4-6 入参检查和debug模式开发</strong></p> <p>这里就进行如参检查，是要判断是否进入调试模式，如果带有 --debug参数，我们要进行log的level设置。</p> <ul><li>实现方式：使用minimist第三方库。</li> <li>查看是否包含debug参数，直接：require('minimist')(process.argv.slice(2)).debug即可。</li> <li>若上值为true，直接修改log.level即可。</li></ul> <p><strong>4-7 环境变量检查功能开发</strong></p> <ul><li>检查环境变量，我们使用第三方库：dotenv。</li> <li>用法：require('dotenv').config({ path: '' }) ：若不传参数，我们在当前目录下拿到.env文件中的变量，之后就可以直接在process.env中使用了。支持传入path变量。</li> <li>环境变量其实就是一个全局变量,如果我们有很多的环境变量需要使用，可以直接在.env文件宏进行配置</li></ul> <p><strong>4-8 通用npm API模块封装 | <strong>4-9 npm全局更新功能开发</strong></strong>
准备阶段的最后一个功能：检查我们的这个脚手架是否为最新版本</p> <p>步骤：</p> <ol><li>获取当前版本号与模块名: pkg.version | pkg.name</li> <li>调用npm API获取所有模版号：</li></ol> <p>npm提供了这样一个API: https://registry.npmjs.org/cloudscope-cli/core ,可以获得该包的所有版本号,要从这里拿到所有版本号，我们需要使用第三方库 axios,同时我们也需要添加一个用来url拼接的库：url-join，可以帮助我们进行多参数的拼接，以及我们进行版本对比的第三方库 semver。
3. 获取所有版本号，比对哪些版本号是大于当前版本号
3. 获取最新的版本号，提示用户更新到此版本。</p> <p>将以上代码提交支仓库远程cloudscope-cli的分支 <a href="https://github.com/liugezhou/cloudscope-cli/tree/lesson02" target="_blank" rel="noopener noreferrer">lesson02<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，并合并至main分支。
**</p> <h2 id="第五章-脚手架命令注册实现-基于commander"><a href="#第五章-脚手架命令注册实现-基于commander" class="header-anchor">#</a> 第五章：脚手架命令注册实现(基于commander）</h2> <p><strong>5-1 快速实现一个commander脚手架 ｜ 5-2 commander脚手架全局配置</strong>
之前在学习命令注册的时候，使用的是yrags，本节使用另一个库 commander去实现命令注册
本节代码提交至：<a href="https://github.com/liugezhou/liugezhou-yargs-demo" target="_blank" rel="noopener noreferrer">liugezhou-yargs-demo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
其中 bin/yargs.js是之前学习yargs的demo代码。
bin/commander.js是本节关于commander的代码。</p> <p>我们在这个库的基础上，学习commander的简单用法.</p> <ul><li>首先，安装npm i -S commander</li> <li>然后，在bin/index.js中：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token hashbang comment">#!/usr/bin/env node</span>

<span class="token keyword">const</span> commander <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../package.json&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 获取commander的单例</span>
<span class="token comment">// const {program} = commander</span>

<span class="token comment">// 手动实例化一个Command示例</span>
<span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">commander<span class="token punctuation">.</span>Command</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

program
  <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>bin<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token string">'&lt;command&gt; [options]'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>version<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-d, --debug'</span><span class="token punctuation">,</span> <span class="token string">'是否开启调试模式'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-e, --envName  &lt;envName&gt;'</span> <span class="token punctuation">,</span> <span class="token string">'环境变量'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> options <span class="token operator">=</span> program<span class="token punctuation">.</span><span class="token function">opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>debug<span class="token punctuation">)</span>
  program<span class="token punctuation">.</span><span class="token function">outputHelp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//打印出帮助信息</span>
</code></pre></div><ul><li>liugezhou-test -V,即可看到输入版本号。</li> <li>liugezhou-test -d  // true
<strong>5-3 commander脚手架命令注册的两种方法</strong></li></ul> <p>课程所讲内容：commander命令注册有两种方式：</p> <ol><li>comman API注册命令</li> <li>addCommand API 注册命令</li></ol> <p>现在默认安装commander时，已更新到7.0.0，sam老师写法还是6.X，可参考 <a href="https://github.com/tj/commander.js/blob/HEAD/Readme_zh-CN.md" target="_blank" rel="noopener noreferrer">commader for git<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 配置。本节内容就是对官方文档更新用法之后的学习笔记：</p> <ol><li><p>Commander.js :
完整的node.js命令行解决方法</p></li> <li><p>声明commander变量
为简化声明，Commander提供了一个全局对象</p></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> program <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span>
program<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">'0.0.1'</span><span class="token punctuation">)</span>
</code></pre></div><p>若程序较为复杂，用户需要以多种方式来使用Commander，如单元测试等，可采用创建本地Commander对象的方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>Command <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Command</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
program<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">'0.0.1'</span><span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li>选项</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>program
<span class="token comment">//Commander 使用.option() 方法来定义选项，同时可以附加选项的简介</span>
	<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-d,--debug'</span><span class="token punctuation">,</span><span class="token string">'booelan'</span><span class="token punctuation">)</span> 
<span class="token comment">//选项可以设置一个默认值。</span>
	<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-c, --cheese &lt;type&gt;'</span><span class="token punctuation">,</span> <span class="token string">'add the specified type of cheese'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//必填选项</span>
	<span class="token punctuation">.</span><span class="token function">requiredOption</span><span class="token punctuation">(</span><span class="token string">'-n, --name &lt;type&gt;'</span><span class="token punctuation">,</span> <span class="token string">'name must have cheese'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//通过program.parse(arguments)方法处理参数</span>
program<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>
<span class="token keyword">const</span> ret <span class="token operator">=</span> program<span class="token punctuation">.</span><span class="token function">opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> debug <span class="token operator">=</span> ret<span class="token punctuation">.</span>debug
</code></pre></div><ol start="4"><li>命令</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>program<span class="token punctuation">.</span>
<span class="token comment">//参数支持必须&lt;&gt;,可选[]</span>
	<span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'clone &lt;source&gt; [destination]'</span><span class="token punctuation">)</span>

<span class="token comment">//在参数名后加上...来声明可变参数，且只有最后一个参数支持这种用法</span>
program
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'rmdir &lt;dirs...&gt;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">dirs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dirs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rmdir %s'</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>5-4 commander注册命令的两种高级用法 ｜5-5 再讲3条commander的高级用法</strong></p> <ol><li>监听所有命令输入 : arguments</li> <li>脚手架串行使用</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>   program
      <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'install [name]'</span><span class="token punctuation">,</span><span class="token string">'install package'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        <span class="token literal-property property">executableFile</span><span class="token operator">:</span><span class="token string">'vue'</span>，
     		<span class="token literal-property property">isDefault</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
 	      <span class="token literal-property property">hidden</span><span class="token operator">:</span><span class="token boolean">true</span> <span class="token comment">//command的隐藏</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li>高级定制help信息</li></ol> <ul><li>program.<em>outputHelp()</em></li> <li>_ program.helpInformation() = function(){}_</li> <li><em>program.on('--help'),function(){ console.log('your help information'}</em></li></ul> <ol start="4"><li>高级定制debug模式</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>program<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'optins:debug'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span>debug<span class="token punctuation">)</span><span class="token punctuation">{</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span> <span class="token operator">=</span> <span class="token string">'verbose'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>对未知命令监听二：</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>program<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'command:*'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'未知的命令：'</span> <span class="token operator">+</span> obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> avaliableCommands <span class="token operator">=</span> program<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">cmd</span> <span class="token operator">=&gt;</span> cmd<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'可用命令：'</span><span class="token operator">+</span> avaliableCommands<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="第六章-node项目如何支持es-module【加餐】"><a href="#第六章-node项目如何支持es-module【加餐】" class="header-anchor">#</a> 第六章 Node项目如何支持ES Module【加餐】</h2> <p><strong>6-1 通过webpack完成ES Module资源构建</strong> <strong>模块化</strong></p> <ul><li>CMD/AMD/require.js</li> <li>CommonJS: 加载：require(), 输出：module.exports() || exports.x</li> <li>ES Module: 加载： import, 输出 export.default || export function || export const</li></ul> <p><strong>实现</strong></p> <ul><li>npm i -D webpack webpack-cli</li> <li>touch webpack-config.js</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//webpack-config.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./bin/core.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'/dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span><span class="token string">'core.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token string">'development'</span>
<span class="token punctuation">}</span>

<span class="token comment">// index.js</span>
#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./core'</span><span class="token punctuation">)</span>


<span class="token comment">// core.js</span>
<span class="token keyword">import</span> utils <span class="token keyword">from</span> <span class="token string">'./utils'</span>

<span class="token function">utils</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// utils</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'kskaksk'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>在package.json中添加两个script，分别为 &quot;build&quot;:&quot;webpack&quot;和&quot;dev&quot;:&quot;webpack -w&quot;</li> <li>上面代码通过 npm run build 打包后，将上面index.js中的require修改为 require(&quot;../dist/core.js&quot;)</li> <li>执行 liugezhou-test 看到构建成功。</li></ul> <p><strong>6-2 通过webpack target属性支持Node内置库</strong></p> <ul><li>webpack的target使用</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// npm i -S path-exists</span>
<span class="token comment">// bin/utils.js</span>
<span class="token keyword">import</span> pathExists <span class="token keyword">from</span> <span class="token string">'path-exists'</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> pathExists<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// bin/core.js</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>exists<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">exists</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// webpack.config.js</span>
<span class="token operator">...</span>
	<span class="token literal-property property">target</span><span class="token operator">:</span><span class="token string">&quot;node&quot;</span>
</code></pre></div><ul><li>core.js代码添加</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span> resolve<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>6-3 webpack loader配置babel-loader支持低版本node</strong></p> <p>配置一个最简单babel-loader,需要安装的库
npm i -D
babel-loader @babel/core  @babel/preset-env  @babel/plugin-transform-runtime  @babel/runtime-corejs3</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token string">'./bin/core.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'/dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span><span class="token string">'core.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token comment">//开发模式</span>
  <span class="token comment">// target: 'web'//默认</span>
  <span class="token literal-property property">target</span><span class="token operator">:</span><span class="token string">'node'</span><span class="token punctuation">,</span> <span class="token comment">// 识别内置库</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">presets</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">[</span>
                <span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token literal-property property">corejs</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>
                  <span class="token literal-property property">regenerator</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
                  <span class="token literal-property property">useESModules</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
                  <span class="token literal-property property">helpers</span><span class="token operator">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>6-4 通过Node原生支持ES Module</strong></p> <p>将node版本升级到14.x，代码中将引用的文件，改写后缀名为 .mjs即可。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/liugezhou/daydayup/edit/main//docs/web/03.md" target="_blank" rel="noopener noreferrer">错误反馈</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web/02.html" class="prev">
        02-脚手架架构设计和框架搭建
      </a></span> <span class="next"><a href="/web/04.html">
        04-脚手架命令注册和执行过程开发
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4690e35c.js" defer></script><script src="/assets/js/2.505fbce2.js" defer></script><script src="/assets/js/1.8644e8ec.js" defer></script><script src="/assets/js/67.ab2beac7.js" defer></script>
  </body>
</html>
