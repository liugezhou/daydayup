<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>04-脚手架命令注册和执行过程开发 | 今日前端</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?4ef6dc604509807e9702b3851e114a74";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
      </script>
      </script>
    <script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1183508160150958" crossorigin="anonymous"></script>
    <meta name="description" content="脚手架命令注册和执行过程开发">
    
    <link rel="preload" href="/assets/css/0.styles.ab222855.css" as="style"><link rel="preload" href="/assets/js/app.4690e35c.js" as="script"><link rel="preload" href="/assets/js/2.505fbce2.js" as="script"><link rel="preload" href="/assets/js/1.8644e8ec.js" as="script"><link rel="preload" href="/assets/js/68.fa3c4346.js" as="script"><link rel="prefetch" href="/assets/js/10.cab30127.js"><link rel="prefetch" href="/assets/js/11.dd4acf6f.js"><link rel="prefetch" href="/assets/js/12.30378d2b.js"><link rel="prefetch" href="/assets/js/13.52db13dd.js"><link rel="prefetch" href="/assets/js/14.b1e55c9a.js"><link rel="prefetch" href="/assets/js/15.397321e8.js"><link rel="prefetch" href="/assets/js/16.41ea9dc0.js"><link rel="prefetch" href="/assets/js/17.ae9bd38c.js"><link rel="prefetch" href="/assets/js/18.7f05db4f.js"><link rel="prefetch" href="/assets/js/19.e7419ed2.js"><link rel="prefetch" href="/assets/js/20.5de11ad9.js"><link rel="prefetch" href="/assets/js/21.d1e22ea1.js"><link rel="prefetch" href="/assets/js/22.72ada26c.js"><link rel="prefetch" href="/assets/js/23.c0a0b2d8.js"><link rel="prefetch" href="/assets/js/24.3e816b8b.js"><link rel="prefetch" href="/assets/js/25.3f733c03.js"><link rel="prefetch" href="/assets/js/26.db25a028.js"><link rel="prefetch" href="/assets/js/27.15ed1846.js"><link rel="prefetch" href="/assets/js/28.208ac68e.js"><link rel="prefetch" href="/assets/js/29.69d9bd33.js"><link rel="prefetch" href="/assets/js/3.7a4ab8e5.js"><link rel="prefetch" href="/assets/js/30.f039addb.js"><link rel="prefetch" href="/assets/js/31.b9fd445b.js"><link rel="prefetch" href="/assets/js/32.899591cb.js"><link rel="prefetch" href="/assets/js/33.f3808942.js"><link rel="prefetch" href="/assets/js/34.1c51bd04.js"><link rel="prefetch" href="/assets/js/35.5dec34de.js"><link rel="prefetch" href="/assets/js/36.08add187.js"><link rel="prefetch" href="/assets/js/37.5feb420b.js"><link rel="prefetch" href="/assets/js/38.afefe479.js"><link rel="prefetch" href="/assets/js/39.c9cdfded.js"><link rel="prefetch" href="/assets/js/4.0aef8d22.js"><link rel="prefetch" href="/assets/js/40.96b04497.js"><link rel="prefetch" href="/assets/js/41.04859dc6.js"><link rel="prefetch" href="/assets/js/42.3881136d.js"><link rel="prefetch" href="/assets/js/43.d142a153.js"><link rel="prefetch" href="/assets/js/44.5cb88048.js"><link rel="prefetch" href="/assets/js/45.3541cd11.js"><link rel="prefetch" href="/assets/js/46.e6c88c3b.js"><link rel="prefetch" href="/assets/js/47.3f992b97.js"><link rel="prefetch" href="/assets/js/48.5996b4fc.js"><link rel="prefetch" href="/assets/js/49.fea4d36b.js"><link rel="prefetch" href="/assets/js/5.baaddd77.js"><link rel="prefetch" href="/assets/js/50.4cd3422c.js"><link rel="prefetch" href="/assets/js/51.228fffda.js"><link rel="prefetch" href="/assets/js/52.92861e6c.js"><link rel="prefetch" href="/assets/js/53.b72d8ce0.js"><link rel="prefetch" href="/assets/js/54.c15c9cdc.js"><link rel="prefetch" href="/assets/js/55.9bc4f52b.js"><link rel="prefetch" href="/assets/js/56.947ab898.js"><link rel="prefetch" href="/assets/js/57.fa37cf58.js"><link rel="prefetch" href="/assets/js/58.d682c2a2.js"><link rel="prefetch" href="/assets/js/59.4499ef43.js"><link rel="prefetch" href="/assets/js/6.f5ab8614.js"><link rel="prefetch" href="/assets/js/60.aa57de27.js"><link rel="prefetch" href="/assets/js/61.5049d857.js"><link rel="prefetch" href="/assets/js/62.ec9a8087.js"><link rel="prefetch" href="/assets/js/63.38b9610d.js"><link rel="prefetch" href="/assets/js/64.0034d3be.js"><link rel="prefetch" href="/assets/js/65.5a44c8b1.js"><link rel="prefetch" href="/assets/js/66.ad0a55cb.js"><link rel="prefetch" href="/assets/js/67.ab2beac7.js"><link rel="prefetch" href="/assets/js/69.4c304a67.js"><link rel="prefetch" href="/assets/js/7.62e43543.js"><link rel="prefetch" href="/assets/js/70.9965b915.js"><link rel="prefetch" href="/assets/js/71.f5f8e219.js"><link rel="prefetch" href="/assets/js/72.afe95f75.js"><link rel="prefetch" href="/assets/js/73.55da3950.js"><link rel="prefetch" href="/assets/js/74.860ada40.js"><link rel="prefetch" href="/assets/js/75.66a003ea.js"><link rel="prefetch" href="/assets/js/76.886902cd.js"><link rel="prefetch" href="/assets/js/77.680b69b8.js"><link rel="prefetch" href="/assets/js/78.6440c559.js"><link rel="prefetch" href="/assets/js/79.4f3af818.js"><link rel="prefetch" href="/assets/js/80.b04f59cc.js"><link rel="prefetch" href="/assets/js/81.d4c4e4b3.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.03d43e08.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ab222855.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.ico" alt="今日前端" class="logo"> <span class="site-name can-hide">今日前端</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/daily/day30.html" class="nav-link">
  今日前端
</a></div><div class="nav-item"><a href="/github/before.html" class="nav-link">
  Github网站食用
</a></div><div class="nav-item"><a href="/web/before.html" class="nav-link">
  前端脚手架
</a></div><div class="nav-item"><a href="https://blog.liugezhou.online" target="_blank" rel="noopener noreferrer" class="nav-link external">
  他的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/liugezhou/daydayup" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/daily/day30.html" class="nav-link">
  今日前端
</a></div><div class="nav-item"><a href="/github/before.html" class="nav-link">
  Github网站食用
</a></div><div class="nav-item"><a href="/web/before.html" class="nav-link">
  前端脚手架
</a></div><div class="nav-item"><a href="https://blog.liugezhou.online" target="_blank" rel="noopener noreferrer" class="nav-link external">
  他的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/liugezhou/daydayup" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/web/before.html" class="sidebar-link">关于</a></li><li><a href="/web/00.html" class="sidebar-link">00-整体架构设计文档范本V0.1</a></li><li><a href="/web/01.html" class="sidebar-link">01-需求分析与架构设计</a></li><li><a href="/web/02.html" class="sidebar-link">02-脚手架架构设计和框架搭建</a></li><li><a href="/web/03.html" class="sidebar-link">03-脚手架核心流程开发</a></li><li><a href="/web/04.html" aria-current="page" class="active sidebar-link">04-脚手架命令注册和执行过程开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/04.html#第一章-本周导学" class="sidebar-link">第一章：本周导学</a></li><li class="sidebar-sub-header"><a href="/web/04.html#第二章-imooc-cli脚手架命令注册" class="sidebar-link">第二章：imooc-cli脚手架命令注册</a></li><li class="sidebar-sub-header"><a href="/web/04.html#第三章-高性能脚手架架构设计和缓存结构设计" class="sidebar-link">第三章：高性能脚手架架构设计和缓存结构设计</a></li><li class="sidebar-sub-header"><a href="/web/04.html#第四章-通用-npm-模块类-package-封装" class="sidebar-link">第四章 通用 npm 模块类 Package 封装</a></li><li class="sidebar-sub-header"><a href="/web/04.html#第五章-预备知识-node-多进程开发入门" class="sidebar-link">第五章：预备知识：Node 多进程开发入门</a></li><li class="sidebar-sub-header"><a href="/web/04.html#第六章-基于-node-多进程构建高性能脚手架" class="sidebar-link">第六章 基于 Node 多进程构建高性能脚手架</a></li><li class="sidebar-sub-header"><a href="/web/04.html#第七章-加餐-node-进阶-child-process-源码分析" class="sidebar-link">第七章 加餐：Node 进阶： child_process 源码分析</a></li></ul></li><li><a href="/web/05.html" class="sidebar-link">05-脚手架创建项目流程设计和开发</a></li><li><a href="/web/06.html" class="sidebar-link">06-脚手架项目和组件初始化开发</a></li><li><a href="/web/14.html" class="sidebar-link">14-服务端选型：磨刀不如砍柴功</a></li><li><a href="/web/15.html" class="sidebar-link">15-服务端 CI_CD：Github 自动化</a></li><li><a href="/web/16.html" class="sidebar-link">16-编辑器服务端API开发</a></li><li><a href="/web/17.html" class="sidebar-link">17-编辑器服务端调用第三方服务</a></li><li><a href="/web/28.html" class="sidebar-link">28-脚手架发布模块架构设计和核心流程开发</a></li><li><a href="/web/29.html" class="sidebar-link">29-脚手架发布模式git自动化流程开发</a></li><li><a href="/web/30.html" class="sidebar-link">30-脚手架发布模块云构建系统开发</a></li><li><a href="/web/31.html" class="sidebar-link">31-脚手架发布模块云发布功能开发</a></li><li><a href="/web/32.html" class="sidebar-link">32-脚手架组件发布功能开发</a></li><li><a href="/web/33.html" class="sidebar-link">33-组件平台开发</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>本Week代码提交支：<a href="https://github.com/liugezhou/cloudscope-cli/tree/lesson04" target="_blank" rel="noopener noreferrer">lesson04<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="第一章-本周导学"><a href="#第一章-本周导学" class="header-anchor">#</a> 第一章：本周导学</h2> <p><strong>1-1 本周整体内容介绍和学习方法</strong></p> <p>标题</p> <ul><li>基于Commander完成脚手架命令注册和命令执行过程开发</li></ul> <p>收获</p> <ul><li>如何设计高性能脚手架</li> <li>Node多线程开发</li> <li>javascript面向对象编程的实战技巧</li></ul> <p>内容</p> <ul><li>图解高性能脚手架架构设计方法</li> <li>封装通用的Package和Command类</li> <li>基于缓存 + Node 多进程 实现动态命令加载和执行</li> <li>将业务逻辑和脚手架逻辑彻底解耦</li></ul> <p>加餐
Node多进程开发进阶--child_process源码解析</p> <ul><li>深入Node源码看清spawn/exec/execFile/fork的本质区别，彻底搞懂Node多进程原理。</li></ul> <h2 id="第二章-imooc-cli脚手架命令注册"><a href="#第二章-imooc-cli脚手架命令注册" class="header-anchor">#</a> 第二章：imooc-cli脚手架命令注册</h2> <p><strong>2-1 imooc-cli脚手架初始化+全局参数注册</strong>
(本节有代码编写)</p> <p>本节的主要内容为使用commander这个库在全局添加注册命令</p> <ul><li>cd core/cli</li> <li>npm i -S commander</li></ul> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// core/cli/lib/index  添加全局注册命令方法</span>
<span class="token comment">//命令注册</span>
<span class="token keyword">function</span> <span class="token function">registerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    program
        <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>bin<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token string">'&lt;command&gt; [options]'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>version<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-d, --debug'</span><span class="token punctuation">,</span> <span class="token string">'是否开启调试模式'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// 开启debug模式</span>
     program<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'option:debug'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span><span class="token function">opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>debug<span class="token punctuation">)</span><span class="token punctuation">{</span>
            process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span><span class="token operator">=</span><span class="token string">'verbose'</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span><span class="token operator">=</span><span class="token string">'info'</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span>level <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 对未知命令监听</span>
    program<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'command:*'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> availableCommands <span class="token operator">=</span> program<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>cmd <span class="token operator">=&gt;</span> cmd<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'未知的命令：'</span><span class="token operator">+</span>obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>availableCommands<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'可用命令为：'</span><span class="token operator">+</span>availableCommands<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
 

    program<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span>args <span class="token operator">&amp;&amp;</span> program<span class="token punctuation">.</span>args<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        program<span class="token punctuation">.</span><span class="token function">outputHelp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>2-2 imooc-cli脚手架命令注册</strong></p> <p>(本节有代码编写)</p> <p>本节的主要内容为添加第一个comman操作：'<strong>init</strong>',并在commands文件夹下创建新的init包</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// core/cli/lib/index</span>
<span class="token operator">...</span><span class="token operator">...</span>

<span class="token keyword">const</span> init <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@cloudscope-cli/init'</span><span class="token punctuation">)</span>

<span class="token operator">...</span><span class="token operator">...</span>

program
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'init [projectName]'</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-f,--force'</span><span class="token punctuation">,</span><span class="token string">'是否强制更新项目'</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span>init<span class="token punctuation">)</span>

<span class="token operator">...</span><span class="token operator">...</span>
</code></pre></div><h2 id="第三章-高性能脚手架架构设计和缓存结构设计"><a href="#第三章-高性能脚手架架构设计和缓存结构设计" class="header-anchor">#</a> 第三章：高性能脚手架架构设计和缓存结构设计</h2> <p><strong>3-1 当前imooc-cli脚手架架构痛点分析</strong>
(本节无代码编写)</p> <p>当前的代码架构如图：
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/4-1.1i06rp47u534.webp" alt="4-1"> <strong>3-2 高性能脚手架架构设计</strong></p> <p>(本节无代码编写)</p> <p>对以上架构(之前代码编写)的主要优化点有以下三个方面</p> <ul><li>将init命令做成了一个动态加载的形式</li> <li>动态加载的脚手架通过缓存形式进行存储：执行哪个命令下载哪个命令</li> <li>动态加载的时候，通过node多进程进行执行：深挖cpu性能</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/4-2.5444cg85tuk0.webp" alt="4-2"> <strong>3-3 脚手架命令动态加载功能架构设计</strong>
(本节无代码编写)
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/4-3.3epstrvnolk0.webp" alt="4-3"></p> <blockquote><p>上图架构初看有些难度，在代码编写之后再去回顾，会有更深理解。</p> <p>本节简单讲述了两点：</p> <ol><li>require加载文件的用法:</li></ol></blockquote> <ul><li>require('/xxx/yyy/index.js') ---- 加载绝对路径</li> <li>require('./index.js')----加载相对路径</li> <li>require('fs')    ----  加载内置模块</li> <li>require('npmlog') ---- 加载第三方包</li></ul> <blockquote><ol start="2"><li>node执行模块两种方式</li></ol></blockquote> <ul><li>node 执行文件: ** node core/cli/bin/index.js**</li> <li>node -e '字符串'：<strong>node  -e  &quot;require(./core/cli/bin/index.js)&quot;</strong></li></ul> <h2 id="第四章-通用-npm-模块类-package-封装"><a href="#第四章-通用-npm-模块类-package-封装" class="header-anchor">#</a> 第四章 通用 npm 模块类 Package 封装</h2> <p><strong>4-1 脚手架命令本地调试功能支持</strong></p> <p>(本节有代码编写)</p> <blockquote><p>通过前面画图了解，我们要实现的第一步是initCommand的动态命令加载,即<strong>3-3</strong>章节所示图。
是否执行本地代码，我们通过一个属性来进行标识：<strong>targetPath</strong></p></blockquote> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">//core/cli/lib/index.js</span>

program<span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-tp, --targetPath &lt;targetPath&gt;'</span><span class="token punctuation">,</span><span class="token string">'是否指定本地调试文件路径'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>

 <span class="token comment">//指定targetPath</span>
program<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'option:targetPath'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_TARGET_PATH</span> <span class="token operator">=</span> program<span class="token punctuation">.</span><span class="token function">opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>targetPath 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// commands/init/lib/index.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span>projectName<span class="token punctuation">,</span>options<span class="token punctuation">,</span>command<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'init'</span><span class="token punctuation">,</span>projectName<span class="token punctuation">,</span>command<span class="token punctuation">.</span><span class="token function">opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>force<span class="token punctuation">,</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_TARGET_PATH</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> init<span class="token punctuation">;</span>

</code></pre></div><blockquote><p>本节需要注意的一点是如果commander版本低于7.0.0，那么 program.action()中传入的参数为两个。
7.0.0版本以上的传入的参数为三个(name.options,cmd)</p> <p>另外，访问targetPath这个参数的时候，需要program.opts().targetPath访问。</p></blockquote> <p><strong>4-2 动态执行库exec模块创建</strong></p> <p>(本节有代码编写)</p> <blockquote><p>core下新建包文件： lerna create @cloudscope-cli/exec  core/
然后在core/cli/lib/index.js文件中将exec包引入，将action(init)此处改为action(exec)</p></blockquote> <p><strong>4-3 创建npm模块通用类Package</strong></p> <p>(本节有代码编写)</p> <blockquote><p>首先讲解了exec模块逻辑</p> <ol><li>targetPath -&gt; modulePath</li> <li>modulePath -&gt; Package(npm模块)</li> <li>Package.getRootFile(获取入口文件)</li> <li>Package.update / Package.install</li></ol></blockquote> <p>代码实现：</p> <ul><li>在model文件下创建新的模块Package：lerna create @cloudscope-cli/package</li> <li>在core/exec/lib/index.js文件中引入：const Package =  require('@cloudscope-cli/package')</li></ul> <p><strong>4-4 Package类的属性、方法定义及构造函数逻辑开发</strong></p> <p>(本节有代码编写)</p> <blockquote><p>本节主要有三处代码讲解</p></blockquote> <ul><li>core/exec中创建一个Package对象</li> <li>model/package中Package类的构造方法</li> <li>utils/utils中添加isObject方法：判断一个属性是否为对象
代码分别如下：</li></ul> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// core/exec/lib/index.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Package <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@cloudscope-cli/package'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> log <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@cloudscope-cli/log'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token constant">SETTINGS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    init<span class="token operator">:</span> <span class="token string">'@cloudscope-cli/init'</span>
 <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. targetPath -&gt; modulePath</span>
   <span class="token comment">// 2. modulePath -&gt; Package(npm模块)</span>
   <span class="token comment">// 3. Package.getRootFile(获取入口文件)</span>
   <span class="token comment">// 4. Package.update / Package.install'</span>
    <span class="token keyword">let</span> targetPath <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_TARGET_PATH</span>
    <span class="token keyword">const</span> homePath <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_HOME_PATH</span>
    <span class="token keyword">let</span> storeDir <span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pkg<span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'targetPath'</span><span class="token punctuation">,</span> targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'homePath'</span><span class="token punctuation">,</span> homePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cmdObj <span class="token operator">=</span> arguments<span class="token punctuation">[</span>arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cmdName <span class="token operator">=</span> cmdObj<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">const</span> packageName <span class="token operator">=</span> <span class="token constant">SETTINGS</span><span class="token punctuation">[</span>cmdName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> packageVersion <span class="token operator">=</span> <span class="token string">'latest'</span><span class="token punctuation">;</span>
     pkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        targetPath<span class="token punctuation">,</span>
        storeDir<span class="token punctuation">,</span>
        packageName<span class="token punctuation">,</span>
        packageVersion
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> exec<span class="token punctuation">;</span>

</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">//models/package/lib/index.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> isObject <span class="token punctuation">}</span>  <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@liugezhou-cli-dev/utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Package</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>options<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Package类的options参数不能为空！'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Package类的options参数必须为对象！'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// package路径</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>targetPath <span class="token operator">=</span> options<span class="token punctuation">.</span>targetPath
        <span class="token comment">// package的存储路径</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storeDir <span class="token operator">=</span> options<span class="token punctuation">.</span>storeDir
        <span class="token comment">// package的name</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>packageName <span class="token operator">=</span> options<span class="token punctuation">.</span>packageName
        <span class="token comment">// package的version</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>packageVersion <span class="token operator">=</span> options<span class="token punctuation">.</span>packageVersion<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 判断当前Package是否存在</span>
    <span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// 安装Package</span>
    <span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">//更新Package</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">//获取入口文件路径</span>
    <span class="token function">getRootFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Package<span class="token punctuation">;</span>

</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">//utils/utils/lib/index.js</span>

<span class="token string">'use strict'</span>
<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'Object'</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
 	isObject 
<span class="token punctuation">}</span>
</code></pre></div><p><strong>4-5 Package类获取入口文件路径功能开发（pkg-dir应用+解决不同操作系统路径兼容问题）</strong>
(本节有代码编写)
本节主要实现models/package/lib/index.js中获取入口文件路径的方法实现getRootfile()</p> <p>思路：</p> <ol><li>获取package.json的所在目录--通过安装pkg-dir库</li> <li>读取package.json</li> <li>寻找main/lib</li> <li>路径的兼容macOS/windows --新建包：utils/format-path，且新建路径兼容方法</li></ol> <p>核心代码为</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">//core/exec/lib/index.js</span>
…………
<span class="token comment">// 1. 获取package.json所在目录</span>
<span class="token keyword">const</span> dir <span class="token operator">=</span> <span class="token function">pkgDir</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 2. 读取package.json</span>
  <span class="token keyword">const</span> pkgFile <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. 寻找main/lib</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgFile <span class="token operator">&amp;&amp;</span> pkgFile<span class="token punctuation">.</span>main<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4. 路径的兼容(macOS/windows)</span>
    <span class="token keyword">return</span> <span class="token function">formatPath</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> pkgFile<span class="token punctuation">.</span>main<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
…………
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">formatPath</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sep <span class="token operator">=</span> path<span class="token punctuation">.</span>sep<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> p <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>sep <span class="token operator">!==</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> p
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> formatPath<span class="token punctuation">;</span>
</code></pre></div><p><strong>4-6 利用npminstall库安装npm模块</strong></p> <p>(本节有代码编写)
本节实现的内容为exec中的install方法,通过npminstall这个库。
使用之前现在测试项目下使用之：<a href="https://github.com/liugezhou/liugezhou-yargs-demo/blob/main/bin/npminstall.js" target="_blank" rel="noopener noreferrer">测试代码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> npminstall <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'npminstall'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> userHome <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'user-home'</span><span class="token punctuation">)</span>
<span class="token function">npminstall</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    root<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>userHome<span class="token punctuation">,</span><span class="token string">'.cli-test'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//模块路径</span>
    storeDir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>userHome<span class="token punctuation">,</span><span class="token string">'.cli-test'</span><span class="token punctuation">,</span><span class="token string">'node_modules'</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
    registry<span class="token operator">:</span><span class="token string">'https://registry.npmjs.org'</span><span class="token punctuation">,</span>
    pkgs<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'foo'</span><span class="token punctuation">,</span>version<span class="token operator">:</span><span class="token string">'~1.0.0'</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ol><li>首先，我们的项目在开发过程中可能会有错误，有的需要去看执行栈，有的不需要，因此我们在core/cli/lib/index中的core方法中，catch语句中加入如下代码(debug模式下显示执行栈错误)</li></ol> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">if</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span><span class="token function">opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>debug<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2.在core/exec/lib/index.js文件中，我们修改代码如下(主要加入了如果不存在targetPath的逻辑梳理)：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>   <span class="token comment">//新添加</span>
<span class="token keyword">const</span> Package <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@cloudscope-cli/package'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> log <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@cloudscope-cli/log'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token constant">SETTINGS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment">//新添加</span>
    init<span class="token operator">:</span> <span class="token string">'@imooc-cli/init'</span>
 <span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">CATCH_DIR</span> <span class="token operator">=</span> <span class="token string">'dependencies'</span>  <span class="token comment">//新添加</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> targetPath <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_TARGET_PATH</span>
    <span class="token keyword">const</span> homePath <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_HOME_PATH</span>
    <span class="token keyword">let</span> storeDir <span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pkg<span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'targetPath'</span><span class="token punctuation">,</span> targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'homePath'</span><span class="token punctuation">,</span> homePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cmdObj <span class="token operator">=</span> arguments<span class="token punctuation">[</span>arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cmdName <span class="token operator">=</span> cmdObj<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">const</span> packageName <span class="token operator">=</span> <span class="token constant">SETTINGS</span><span class="token punctuation">[</span>cmdName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> packageVersion <span class="token operator">=</span> <span class="token string">'latest'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment">//生成缓存路径</span>
       targetPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>homePath<span class="token punctuation">,</span><span class="token constant">CATCH_DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//新添加</span>
       storeDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span><span class="token string">'node_modules'</span><span class="token punctuation">)</span>  <span class="token comment">//新添加</span>
       log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'targetPath:'</span><span class="token punctuation">,</span>targetPath<span class="token punctuation">)</span>  <span class="token comment">//新添加</span>
       log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'storeDir:'</span><span class="token punctuation">,</span>storeDir<span class="token punctuation">)</span>      <span class="token comment">//新添加</span>
       pkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span><span class="token punctuation">{</span>     								<span class="token comment">//新添加</span>
         targetPath<span class="token punctuation">,</span>
         storeDir<span class="token punctuation">,</span>
         packageName<span class="token punctuation">,</span>
         packageVersion
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">await</span> pkg<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">//新添加</span>
         <span class="token comment">// 更新package</span>
         log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'更新package'</span><span class="token punctuation">)</span>
         <span class="token keyword">await</span> pkg<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
         <span class="token comment">// 安装package</span>
         <span class="token keyword">await</span> pkg<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      pkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
         targetPath<span class="token punctuation">,</span>
         packageName<span class="token punctuation">,</span>
         packageVersion
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> rootFile <span class="token operator">=</span> pkg<span class="token punctuation">.</span><span class="token function">getRootFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>rootFile<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">//新添加</span>
         <span class="token keyword">require</span><span class="token punctuation">(</span>rootFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> exec<span class="token punctuation">;</span>

</code></pre></div><ol start="3"><li>model/package包中文件主要加入了安装package这个方法,使用了npminstall这个库。</li></ol> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">//models/package/lib/ibdex.js</span>

 <span class="token keyword">async</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span> <span class="token function">npminstall</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     root<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetPath<span class="token punctuation">,</span>
     storeDir<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeDir<span class="token punctuation">,</span>
     registry<span class="token operator">:</span><span class="token function">getDefaultRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     pkg<span class="token operator">:</span><span class="token punctuation">{</span>
       name<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
       version<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>packageVersion
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>

</code></pre></div><p><strong>4-7 Package类判断模块是否存在方法开发</strong>
(本节有代码编写)
本节的主要内容是实现package/lib/index.js中的exists方法，代码实现如下：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>
…………

 <span class="token comment">// package的缓存目录前缀</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cacheFilePathPrefix <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span>

…………
<span class="token keyword">get</span> <span class="token function">cacheFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> 	path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeDir<span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheFilePathPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>packageVersion<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeDir <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">pathExists</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fse<span class="token punctuation">.</span><span class="token function">mkdirpSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeDir<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>packageVersion <span class="token operator">===</span> <span class="token string">'latest'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>packageVersion <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getNpmLatestVersion</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeDir<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> <span class="token function">pathExists</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">pathExists</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>4-8 Package类更新模块逻辑开发</strong></p> <p>(本节有代码编写)
本节内容主要为如果Package包有升级，那么需要去更新，主要实现代码为：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// models/package/lib/index.js</span>

…………
<span class="token function">getSpecificCacheFilePath</span><span class="token punctuation">(</span>packageVersion<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeDir<span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheFilePathPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageVersion<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token comment">//更新Package</span>
<span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//获取最新的npm模块版本号</span>
  <span class="token keyword">const</span> latestPackageVersion <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getNpmLatestVersion</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 查询最新版本号对应的路径是否存在</span>
  <span class="token keyword">const</span> latestFilePath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSpecificCacheFilePath</span><span class="token punctuation">(</span>latestPackageVersion<span class="token punctuation">)</span>
  <span class="token comment">// 如果不存在，则直接安装最新版本</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">pathExists</span><span class="token punctuation">(</span>latestFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">npminstall</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      root<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetPath<span class="token punctuation">,</span>
      storeDir<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeDir<span class="token punctuation">,</span>
      registry<span class="token operator">:</span><span class="token function">getDefaultRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      pkgs<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
        version<span class="token operator">:</span>latestPackageVersion
      <span class="token punctuation">}</span>
           <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>packageVersion <span class="token operator">=</span> latestPackageVersion
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>packageVersion <span class="token operator">=</span> latestPackageVersion
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> latestFilePath<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>4-9 Package类获取缓存模块入口文件功能改造</strong></p> <p>(本节有代码编写)</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">//获取入口文件路径</span>
    <span class="token function">getRootFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">function</span> <span class="token function">_getRootFile</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1. 获取package.json所在目录</span>
            <span class="token keyword">const</span> dir <span class="token operator">=</span> <span class="token function">pkgDir</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 2. 读取package.json</span>
              <span class="token keyword">const</span> pkgFile <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 3. 寻找main/lib</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgFile <span class="token operator">&amp;&amp;</span> pkgFile<span class="token punctuation">.</span>main<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 4. 路径的兼容(macOS/windows)</span>
                <span class="token keyword">return</span> <span class="token function">formatPath</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> pkgFile<span class="token punctuation">.</span>main<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">_getRootFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">_getRootFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>ps：关于项目的代码以上就结束了，代码提交至：<a href="https://github.com/liugezhou/cloudscope-cli/tree/lesson04" target="_blank" rel="noopener noreferrer">lesson04<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="第五章-预备知识-node-多进程开发入门"><a href="#第五章-预备知识-node-多进程开发入门" class="header-anchor">#</a> 第五章：预备知识：Node 多进程开发入门</h2> <p><strong>5-1 进程的基本概念(讲解在操作系统中如何查看进程的嵌套关系)</strong></p> <p>官方文档中文版： <a href="http://nodejs.cn/api/child_process.html" target="_blank" rel="noopener noreferrer">http://nodejs.cn/api/child_process.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>进程：进程(Process)是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单元，是操作系统结构的基础。
概念主要两点：</p> <ul><li>第一，进程是一个实体。每一个进程都有它自己的地址空间。</li> <li>第二，进程是一个“执行中的程序”，存在嵌套关系</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/4-4.4uu4pjciaww0.webp" alt="4-4"></p> <p>Node进程存在的感知：
终端中输入：ps -ef | grep node 命令。</p> <ul><li>UID是当前用户获取权限的ID</li> <li>PID是当前进程ID</li> <li>PPID是当前进程ID的父ID</li></ul> <p>使用webstorm调试一个node程序的图示如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/4-5.1th8sx2izpb4.webp" alt="4-5"></p> <p><strong>5-2 child_process异步方法使用教程（exec&amp;execFile）</strong>
child_process用法:
异步用法</p> <ul><li>exec</li> <li>execFile</li> <li>fork</li> <li>spawn</li></ul> <p>同步用法</p> <ul><li>execSync</li> <li>execFileSync</li> <li>spawnSync</li></ul> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">//exec使用方法demo</span>
<span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>

cp<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'ls -al'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>stdout<span class="token punctuation">,</span>stderr<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stderr<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//execFile使用方法demo</span>
cp<span class="token punctuation">.</span><span class="token function">execFile</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'-al'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>stdout<span class="token punctuation">,</span>stderr<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stderr<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>小结：exec和execFile在输出上看不出来区别。</p> <ul><li>exec主要用来执行一个shell命令，本质是execFile，只是参数不同，不支持传入arguments参数。</li> <li>execFile只能执行一个文件，且加入一些命令，不能使用管道符。</li></ul> <p><strong>5-3 child_process spawn用法以及与exec&amp;execFile的区别</strong>
exec、execFile、fork底层都是使用的spawn。
spawn使用的时候，没有回调，需要监听获取结果。    
新建一个test.shell文件的时候，如果要读取这个文件，那么需要添加权限：chmod +x test.shell</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'test.shell'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'-al'</span><span class="token punctuation">,</span><span class="token string">'-bl'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    cwd<span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// console.log(child.pid,process.pid)</span>
child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stdout'</span><span class="token punctuation">,</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stderr'</span><span class="token punctuation">,</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>spawn:耗时任务(比如 npm install)：    不断打印日志
exec/execFile:耗时、开销比较小的任务:    一次性返回结果。
fork：多进程、多线程的下载。</p> <p><strong>5-4 child_process fork用法及父子进程通信机制讲解</strong></p> <p>fork主要是使用node来执行我们的命令。
fork会执行两个进程 主进程与子进程。
fork的本质也是调用spawn。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// index.js</span>
<span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'child.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello child process！'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// child.disconnect()</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'main pid:'</span><span class="token punctuation">,</span>process<span class="token punctuation">.</span>pid<span class="token punctuation">)</span>

child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span>msg <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    child<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//child.js</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child pid：'</span><span class="token punctuation">,</span>process<span class="token punctuation">.</span>pid<span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello main process!'</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>5-5 child_process同步方法使用教程</strong></p> <ul><li>execSync</li> <li>execFileSync</li> <li>spawnSync</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>

<span class="token comment">//execSync</span>
<span class="token keyword">const</span> ret <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'ls -al | grep index.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//execFileSync</span>
<span class="token keyword">const</span> ret2 <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">execFileSync</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-al'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//spawnSync</span>
<span class="token keyword">const</span> ret3 <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawnSync</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'-al'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret3<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="第六章-基于-node-多进程构建高性能脚手架"><a href="#第六章-基于-node-多进程构建高性能脚手架" class="header-anchor">#</a> 第六章 基于 Node 多进程构建高性能脚手架</h2> <p><strong>6-1 通过脚手架命令Command类封装</strong></p> <p>(本节有代码编写)</p> <ul><li>在 model文件夹下安装Command包：lerna create @cloudscope-cli/command</li> <li>在commands/init 的package.json中引入上面新创建的包command，继承它作为它的子类。</li></ul> <p>然后我们来到新建的command包的lib/index文件中,添加如下代码(同时删除core/cli/lib/index.js中关于checNodeVersion方法的代码)：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> semver <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'semver'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> colors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'colors/safe'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span>  <span class="token constant">LOWEST_NODE_VERSION</span> <span class="token operator">=</span> <span class="token string">'12.0.0'</span>

<span class="token keyword">class</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">argv</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_argv <span class="token operator">=</span> argv
        <span class="token keyword">let</span> runner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> chain <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            chain <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkNodeVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            chain<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

     <span class="token function">checkNodeVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> currentNodeVersion <span class="token operator">=</span> process<span class="token punctuation">.</span>version
        <span class="token keyword">const</span> lowestNodeVersion <span class="token operator">=</span> <span class="token constant">LOWEST_NODE_VERSION</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>semver<span class="token punctuation">.</span><span class="token function">ltr</span><span class="token punctuation">(</span>currentNodeVersion<span class="token punctuation">,</span> lowestNodeVersion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cloudscope-cli 需要安装 v</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lowestNodeVersion<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">以上版本的node.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'init必须实现'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'exec必须实现'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Command<span class="token punctuation">;</span>

</code></pre></div><p>接着，我们来到commands/init/lib/index.js文件中，进行代码的改写：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Command <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@cloudscope-cli/command'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">InitCommand</span> <span class="token keyword">extends</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span class="token comment">// function init(projectName,options,command)  {</span>
    <span class="token comment">// console.log('init',projectName,command.opts().force,process.env.CLI_TARGET_PATH)</span>
<span class="token comment">// }</span>
<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">argv</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InitCommand</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> init
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>InitCommand <span class="token operator">=</span> InitCommand<span class="token punctuation">;</span>

</code></pre></div><p>这里的argv参数传递是从 exec/lib/index.js中的require传递过来的，因此参数传递修改</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">require</span><span class="token punctuation">(</span>rootFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//修改为</span>
<span class="token function">require</span><span class="token punctuation">(</span>rootFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>6-2 脚手架参数初始化方法开发</strong></p> <p>(本节有代码编写)</p> <ul><li>首先在command包中引入log包，用于chain的catch错误打印(上节代码已更新)</li> <li>其次，对于class Comman需要对传入的参数argv进行一个判断，
<ul><li>如果为空需要抛出异常，这里需要注意抛出的异常在core/cli/lib/index.js中并没有捕获，需要在core/exec/lib/index.js中require的这个targetPath文件进行try catch捕获。</li> <li>对argv这个参数进行是否对数组的判断。</li> <li>对argv是否为空数组进行判断</li></ul></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>argv<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'argv参数不能为空'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'argv参数必须为数组'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>argv<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'参数列表为空'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>在chain里面实现initArgs方法：主要用来进行参数的分解，将argv最后一个参数与之前的参数装到两个参数中去。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//chain逻辑</span>
<span class="token keyword">let</span> chain <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  chain <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkNodeVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	chain <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	chain <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	chain <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	chain<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  	log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">initArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> len <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_argv<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>_cmd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_argv<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//commander版本号为7.0.0需要加opts()</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>_argv <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>chain中的init方法与exec均抛出异常，需要由子类去实现：即commands/init/lib/index.js.
<strong>6-3 利用Node多进程动态执行命令（stdio的inherit属性讲解）</strong></p> <p>(本节有代码编写)
我们回到exec/lib/index.js中，其中之前的那行代码
require(rootFile).call(null,Array.from(<strong>arguments</strong>));
是在当前进程中调用的，我们需要修改为在node进程中进行调用，这便是本节的重点。</p> <p>我们通过本周第五章的内容，已经知道了如何使用child_process下的同步或者异步方法进行子进程的执行，这里我有两种方法可以使用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token comment">// cp.fork()  //这里因为fork没有回调，需要通过通信的方式来获取结果，所以这里不推荐</span>

 <span class="token comment">//之所以不用spawnSync是因为，我们在执行这里的时候是需要不断的用户交互的，需要不断的收到数据打印结果，不要一次性</span>
<span class="token keyword">const</span> child <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'-e'</span><span class="token punctuation">,</span>code<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
	<span class="token literal-property property">cwd</span><span class="token operator">:</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">stdio</span><span class="token operator">:</span><span class="token string">'inherit'</span>   <span class="token comment">// 加入这行代码，下面的就可以注释掉了</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token comment">// child.stdout.on('data',(chunk =&gt;{</span>
<span class="token comment">// }))</span>
<span class="token comment">// child.stderr.on('data',(chunk =&gt;{</span>
<span class="token comment">// }))</span>

<span class="token comment">// 当然存在错误的情况，我们还是需要添加两个监听事件</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'命令执行成功'</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>spawn方法中的参数stdio默认值为'pipe'管道，pipe使得主进程与子进程会产生通信通道，因此需要通过on这种方式去进行监听。
stdio还有一个值为'inherit'，它将相应的stdio传给父进程或者从父进程传入。也就是说：直接将process.stdin、process.stdout、process.stderr直接和父进程进行绑定，这样就无须去监听结果，可以直接将结果打印出来。</p> <p><strong>6-4 生成Node多进程动态执行代码</strong></p> <p>(本节有代码编写)</p> <p>通过上一节的学习，我们通过代码const args = Array.from(<strong>arguments</strong>)
const cmd = args[args.length - 1]可以知道，现在需要做的就是拼成上面spawn在执行时所需的code
我们之前的代码为  <em>require(rootFile).call(null,Array.from(arguments));</em>
_
也就是兼容 conse code = <code>require(rootFile).call(null,Array.from(arguments));</code>
rootfile -&gt; ${rootfile},难点是  Array.from(arguments)的传入。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
<span class="token keyword">const</span> cmd <span class="token operator">=</span> args<span class="token punctuation">[</span>args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>   <span class="token comment">// 拿到command，且进行瘦身，对不需要的参数进行过滤</span>
<span class="token keyword">const</span> o <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span> key<span class="token operator">!==</span><span class="token string">'parent'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     o<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>cmd<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
args<span class="token punctuation">[</span>args<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> o
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">require('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rootFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">').call(null,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>注：由于我使用的commander是7.0.0的，低于此版本传入的参数为两个，但7.0.0版本传入参数为3个，因此上面的代码，我这里直接写成(不知道后续是否还会有错误)：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">require('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rootFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">').call(null,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>到这里，使用node多进程执行代码的功能就完成了。</p> <p><strong>6-5 windows操作系统spawn执行命令兼容</strong></p> <p>(本节有代码编写)</p> <p>windows操作系统与macOS关于spawn的执行是不一样的，本节解决的就是windows操作系统下的兼容
将本方法封装在utils/utils包中：通过process.platform来判断操作系统</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token parameter">command<span class="token punctuation">,</span>args<span class="token punctuation">,</span>options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> win32 <span class="token operator">=</span> process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'win32'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cmd <span class="token operator">=</span> win32 <span class="token operator">?</span> <span class="token string">'cmd'</span><span class="token operator">:</span> command
  <span class="token keyword">const</span> cmdArgs <span class="token operator">=</span> win32  <span class="token operator">?</span>  <span class="token punctuation">[</span><span class="token string">'/c'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span>args<span class="token punctuation">)</span> <span class="token operator">:</span> args<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> cmdArgs<span class="token punctuation">,</span>options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到以上为止，我们完成了动态命令的加载和执行。</p> <h2 id="第七章-加餐-node-进阶-child-process-源码分析"><a href="#第七章-加餐-node-进阶-child-process-源码分析" class="header-anchor">#</a> 第七章 加餐：Node 进阶： child_process 源码分析</h2> <p><strong>7-1 Node多进程child_process库exec方法源码执行流程分析</strong></p> <p>疑问和收获：
exec和execFile到底有什么区别？
为什么exec/execFile/fork都是通过spawn实现的，spawn的作用到底是什么？
为什么spawn调用后没有回调，而exec和execFile能够回调？
为什么spawn调用后需要手动调用child.stdout.on('data',callback),这里的child.stdout/child.stderr到底是什么？
为什么有data/error/exit/close这么多种回调，他们的执行顺序到底是怎样的？</p> <p>exec源码粗略分析
<a href="https://www.processon.com/embed/6031cf99f346fb2a7e1b93a3" target="_blank" rel="noopener noreferrer">点击查看【processon】<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在未学习exec源码之前，我们先对上面的拓扑图进行一个简单的学习，看到exec内部的执行流程
不难看到exec执行的是execlFile这个方法，且不同的地方就是传入的参数不同，而execFile执行的是spawn这个方法，且spawn这个方法调用的是node内部库的一个child_process方法。</p> <p>我们在webstorm中打开一个<a href="https://github.com/liugezhou/liugezhou-yargs-demo" target="_blank" rel="noopener noreferrer">项目<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// /bin/process/index.js</span>
<span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

cp<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'ls -al|grep node_modules '</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>stdout<span class="token punctuation">,</span>stderr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stderr<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>第五行代码打断点，配置webstorm调试设置后，执行命令(我这里是liugezhou-test)，进入到exec源码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token parameter">command<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token function">normalizeExecArgs</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">execFile</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>file<span class="token punctuation">,</span>
                                opts<span class="token punctuation">.</span>options<span class="token punctuation">,</span>
                                opts<span class="token punctuation">.</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>正如上面拓扑图画的那样，首先执行一个normalLizeExecArgs方法，然后调用execFile这个方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">execFile</span><span class="token punctuation">(</span>file <span class="token comment">/* , args, options, callback */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 	………………

  <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">cwd</span><span class="token operator">:</span> options<span class="token punctuation">.</span>cwd<span class="token punctuation">,</span>
    <span class="token literal-property property">env</span><span class="token operator">:</span> options<span class="token punctuation">.</span>env<span class="token punctuation">,</span>
    <span class="token literal-property property">gid</span><span class="token operator">:</span> options<span class="token punctuation">.</span>gid<span class="token punctuation">,</span>
    <span class="token literal-property property">uid</span><span class="token operator">:</span> options<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
    <span class="token literal-property property">shell</span><span class="token operator">:</span> options<span class="token punctuation">.</span>shell<span class="token punctuation">,</span>
    <span class="token literal-property property">windowsHide</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>windowsHide<span class="token punctuation">,</span>
    <span class="token literal-property property">windowsVerbatimArguments</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>windowsVerbatimArguments
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
 	………………
  
  <span class="token keyword">function</span> <span class="token function">exithandler</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> signal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ………………
    
    <span class="token function">callback</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">errorhandler</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   ………………
    <span class="token function">exithandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ………………
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ………………
  <span class="token punctuation">}</span>

  child<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> exithandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  child<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> errorhandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>上面代码的4行，我们看到调用了spawn方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> args<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token function">normalizeSpawnArguments</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> args<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChildProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
……………………

  child<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">file</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>file<span class="token punctuation">,</span>
    <span class="token literal-property property">args</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>args<span class="token punctuation">,</span>
    <span class="token literal-property property">cwd</span><span class="token operator">:</span> options<span class="token punctuation">.</span>cwd<span class="token punctuation">,</span>
    <span class="token literal-property property">windowsHide</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>windowsHide<span class="token punctuation">,</span>
    <span class="token literal-property property">windowsVerbatimArguments</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>windowsVerbatimArguments<span class="token punctuation">,</span>
    <span class="token literal-property property">detached</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>detached<span class="token punctuation">,</span>
    <span class="token literal-property property">envPairs</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>envPairs<span class="token punctuation">,</span>
    <span class="token literal-property property">stdio</span><span class="token operator">:</span> options<span class="token punctuation">.</span>stdio<span class="token punctuation">,</span>
    <span class="token literal-property property">uid</span><span class="token operator">:</span> options<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
    <span class="token literal-property property">gid</span><span class="token operator">:</span> options<span class="token punctuation">.</span>gid<span class="token punctuation">,</span>
    <span class="token literal-property property">serialization</span><span class="token operator">:</span> options<span class="token punctuation">.</span>serialization<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>spawn方法的第2行如拓扑图所示，对参数执行了normalizeSpawnArguments方法，这里通过调试查看参数，发现，opts这个对象的file为 'bin/sh'，这里涉及到一个重要的知识点:</p> <p>shell的使用</p> <ol><li>直接执行shell文件： /bin/sh test.shell</li> <li>直接执行shell语句： /bin/sh -c &quot;ls -al|grep node_modules&quot;</li></ol> <p>spawn方法的第3行 const child = new ChildProcess
通过分析，我们知道这个ChildProcess调用的是内部库 internal/child_process的this._handler,再进一步如拓扑图所示，调用的是c++文件，不做继续跟踪。
继续往后该方法第6行，spwan方法调用的child.spwan如拓扑图所示，真正调用的是internal/child_process中的spawn--&gt;this._hanlde.spawn方法，该方法执行完毕后，子进程便开启了.</p> <p>在spwan最后返回child后，我们再返回到execFile中，发现child.stdout与child.stderr方法的输出，以及回调f
unction exithandler和errorhandler</p> <p>上面就是对exec源码的略读过程。</p> <p><strong>7-2 高能：child_process库exec源码精度</strong>
上一节我们阅读了exec源码的第一遍，对答题流程有了认识，这节开始阅读第二遍，进行细节的解读。</p> <p>首先进入到exec的normalizeExecArgs方法，逻辑简单。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">normalizeExecArgs</span><span class="token punctuation">(</span><span class="token parameter">command<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//判断options是否为function，这一步是对参数的兼容以及参数左移动</span>
    callback <span class="token operator">=</span> options<span class="token punctuation">;</span>
    options <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Make a shallow copy so we don't clobber the user's options object.</span>
  options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>shell <span class="token operator">=</span> <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>shell <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>shell <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">file</span><span class="token operator">:</span> command<span class="token punctuation">,</span>
    <span class="token literal-property property">options</span><span class="token operator">:</span> options<span class="token punctuation">,</span>
    <span class="token literal-property property">callback</span><span class="token operator">:</span> callback
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>然后我们进入到execFile中，分析流程写入到下面代码之中：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// liugehou:此方法只接受了一个参数file，后面的参数通过arguments获取</span>
<span class="token keyword">function</span> <span class="token function">execFile</span><span class="token punctuation">(</span>file <span class="token comment">/* , args, options, callback */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// liugezhou:参数初始化</span>
  <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> callback<span class="token punctuation">;</span>
  <span class="token keyword">let</span> options<span class="token punctuation">;</span>

  <span class="token comment">// Parse the optional positional parameters.</span>
  <span class="token keyword">let</span> pos <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">//liugezhou:意图为拿到arguments的第一个参数，即options，且需满足options为数组时(显然exec进来不满足这个条件)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token function">ArrayIsArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    args <span class="token operator">=</span> arguments<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">//liugezhou:对exec来说arguments[1]传入的为 {shell:true},即也不满足这个条件  </span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pos<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">// liugezhou:如上一注释，这里是满足的，将{shell:true}赋值给optios</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> arguments<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> arguments<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pos<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//liugezhou:满足</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> arguments<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    callback <span class="token operator">=</span> arguments<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callback <span class="token operator">&amp;&amp;</span> pos <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_INVALID_ARG_VALUE</span><span class="token punctuation">(</span><span class="token string">'args'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>   	<span class="token comment">//liugezhou:编码格式</span>
    <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>						<span class="token comment">//liugezhou：超时时间</span>
    <span class="token literal-property property">maxBuffer</span><span class="token operator">:</span> <span class="token constant">MAX_BUFFER</span><span class="token punctuation">,</span><span class="token comment">//liugezhou：缓存区输出的字符串最多的容量(stdout的时候会用到)</span>
    <span class="token literal-property property">killSignal</span><span class="token operator">:</span> <span class="token string">'SIGTERM'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">cwd</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">shell</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>options
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Validate the timeout, if present.</span>
  <span class="token function">validateTimeout</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//liugezhou：判断是否为int，如果不是抛出异常</span>

  <span class="token comment">// Validate maxBuffer, if present.</span>
  <span class="token function">validateMaxBuffer</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>maxBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//liugezhou:判断是否为number，如果不是抛出异常</span>

  options<span class="token punctuation">.</span>killSignal <span class="token operator">=</span> <span class="token function">sanitizeKillSignal</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>killSignal<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">cwd</span><span class="token operator">:</span> options<span class="token punctuation">.</span>cwd<span class="token punctuation">,</span>
    <span class="token literal-property property">env</span><span class="token operator">:</span> options<span class="token punctuation">.</span>env<span class="token punctuation">,</span>
    <span class="token literal-property property">gid</span><span class="token operator">:</span> options<span class="token punctuation">.</span>gid<span class="token punctuation">,</span>
    <span class="token literal-property property">uid</span><span class="token operator">:</span> options<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
    <span class="token literal-property property">shell</span><span class="token operator">:</span> options<span class="token punctuation">.</span>shell<span class="token punctuation">,</span>
    <span class="token literal-property property">windowsHide</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>windowsHide<span class="token punctuation">,</span>
    <span class="token literal-property property">windowsVerbatimArguments</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>windowsVerbatimArguments
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
………………

</code></pre></div><p>上面代码走到51行后，进入spawn源码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> args<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// liugezhou：继续对进来的参数进行一个解析，主要就是参数的处理解析</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token function">normalizeSpawnArguments</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> args<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//liugezhou：这里进入到internal/child_process文件下，重点执行this.handle = new Process()</span>
  <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChildProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  options <span class="token operator">=</span> opts<span class="token punctuation">.</span>options<span class="token punctuation">;</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'spawn'</span><span class="token punctuation">,</span> opts<span class="token punctuation">.</span>args<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//liugezhou：又一个重点，这里的源码底层实现，分析在下一节</span>
  child<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">file</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>file<span class="token punctuation">,</span>
    <span class="token literal-property property">args</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>args<span class="token punctuation">,</span>
    <span class="token literal-property property">cwd</span><span class="token operator">:</span> options<span class="token punctuation">.</span>cwd<span class="token punctuation">,</span>
    <span class="token literal-property property">windowsHide</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>windowsHide<span class="token punctuation">,</span>
    <span class="token literal-property property">windowsVerbatimArguments</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>windowsVerbatimArguments<span class="token punctuation">,</span>
    <span class="token literal-property property">detached</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>detached<span class="token punctuation">,</span>
    <span class="token literal-property property">envPairs</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>envPairs<span class="token punctuation">,</span>
    <span class="token literal-property property">stdio</span><span class="token operator">:</span> options<span class="token punctuation">.</span>stdio<span class="token punctuation">,</span>
    <span class="token literal-property property">uid</span><span class="token operator">:</span> options<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
    <span class="token literal-property property">gid</span><span class="token operator">:</span> options<span class="token punctuation">.</span>gid<span class="token punctuation">,</span>
    <span class="token literal-property property">serialization</span><span class="token operator">:</span> options<span class="token punctuation">.</span>serialization<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>7-3 深度分析child_process库spawn底层实现</strong>
接着上一节代码块中走到了child.spawn：</p> <ul><li>第一步是通过getValidStdio去生成pipe，创建一个管道实例：第一个是输入，第二个是输出，第三个是error(只是生成了管道，但是还没创建socket的通信)</li> <li>第二步对spawn的一些参数进行处理：下面代码未贴</li> <li>第三步通过this._handle.spawn 子进程被创建出来</li> <li>第四步通过createSocket方法，将之前的pipe和子进程与socket绑定。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">ChildProcess</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">spawn</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
………………
  <span class="token comment">//liugezhou:'pipe'管道从这里创建，这里面的代码就不贴了，该代码可以：</span>
  <span class="token comment">//1. stdio可以传入ignore，静默执行，没有输出</span>
  stdio <span class="token operator">=</span> <span class="token function">getValidStdio</span><span class="token punctuation">(</span>stdio<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
………………

  <span class="token comment">//liugezhou:经过这步后，子进程立即被创建出来</span>
  <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_handle<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

……………
  
<span class="token comment">// liugezhou:此循环非常重要，建立起来了父进程与子进程的socket通信</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> stdio<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
………………

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stream<span class="token punctuation">.</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// When i === 0 - we're dealing with stdin</span>
      <span class="token comment">// (which is the only one writable pipe).</span>
      <span class="token comment">//liugezhou：createSocket</span>
      stream<span class="token punctuation">.</span>socket <span class="token operator">=</span> <span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pid <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">?</span>
        stream<span class="token punctuation">.</span>handle <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//liugezhou:到这里就得到了一个socket事例</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pid <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_closesNeeded<span class="token operator">++</span><span class="token punctuation">;</span>
        stream<span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">maybeClose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

………………
  <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>然后我们再返回到execFile中，接着往下走：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">execFile</span><span class="token punctuation">(</span>file <span class="token comment">/* , args, options, callback */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
………………
<span class="token keyword">let</span> encoding<span class="token punctuation">;</span>
  <span class="token comment">//liugezhou：等待输入输出流全部执行完毕后，最后生成内容的数组，这个_stdout是一次性push给我们的，所以这也是我们前面学习说为什么进行耗时任务的时候，不要使用execFile</span>
  <span class="token keyword">const</span> _stdout <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> _stderr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>encoding <span class="token operator">!==</span> <span class="token string">'buffer'</span> <span class="token operator">&amp;&amp;</span> Buffer<span class="token punctuation">.</span><span class="token function">isEncoding</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>encoding<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    encoding <span class="token operator">=</span> options<span class="token punctuation">.</span>encoding<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    encoding <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//定义了一些变量</span>
  ………………

  <span class="token keyword">function</span> <span class="token function">exithandler</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> signal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exited<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    exited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      timeoutId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callback<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// merge chunks</span>
    <span class="token keyword">let</span> stdout<span class="token punctuation">;</span>
    <span class="token keyword">let</span> stderr<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>encoding <span class="token operator">||</span>
      <span class="token punctuation">(</span>
        child<span class="token punctuation">.</span>stdout <span class="token operator">&amp;&amp;</span>
        child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>readableEncoding
      <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      stdout <span class="token operator">=</span> _stdout<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      stdout <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>_stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>encoding <span class="token operator">||</span>
      <span class="token punctuation">(</span>
        child<span class="token punctuation">.</span>stderr <span class="token operator">&amp;&amp;</span>
        child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>readableEncoding
      <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      stderr <span class="token operator">=</span> _stderr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      stderr <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>_stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ex <span class="token operator">&amp;&amp;</span> code <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> signal <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      cmd <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// eslint-disable-next-line no-restricted-syntax</span>
      ex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Command failed: '</span> <span class="token operator">+</span> cmd <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ex<span class="token punctuation">.</span>killed <span class="token operator">=</span> child<span class="token punctuation">.</span>killed <span class="token operator">||</span> killed<span class="token punctuation">;</span>
      ex<span class="token punctuation">.</span>code <span class="token operator">=</span> code <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token function">getSystemErrorName</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">:</span> code<span class="token punctuation">;</span>
      ex<span class="token punctuation">.</span>signal <span class="token operator">=</span> signal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ex<span class="token punctuation">.</span>cmd <span class="token operator">=</span> cmd<span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">errorhandler</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ex <span class="token operator">=</span> e<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>
      child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
      child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">exithandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
………………

  <span class="token comment">//liugezhou：timeout耗时的操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ………………
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>encoding<span class="token punctuation">)</span>
      child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>

    child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">onChildStdout</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> encoding <span class="token operator">=</span> child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>readableEncoding<span class="token punctuation">;</span>
      <span class="token keyword">const</span> length <span class="token operator">=</span> encoding <span class="token operator">?</span>
        Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span> <span class="token operator">:</span>
        chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      stdoutLen <span class="token operator">+=</span> length<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stdoutLen <span class="token operator">&gt;</span> options<span class="token punctuation">.</span>maxBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> truncatedLen <span class="token operator">=</span> options<span class="token punctuation">.</span>maxBuffer <span class="token operator">-</span> <span class="token punctuation">(</span>stdoutLen <span class="token operator">-</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _stdout<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> truncatedLen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ERR_CHILD_PROCESS_STDIO_MAXBUFFER</span><span class="token punctuation">(</span><span class="token string">'stdout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        _stdout<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>encoding<span class="token punctuation">)</span>
      child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>

    child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">onChildStderr</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> encoding <span class="token operator">=</span> child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>readableEncoding<span class="token punctuation">;</span>
      <span class="token keyword">const</span> length <span class="token operator">=</span> encoding <span class="token operator">?</span>
        Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span> <span class="token operator">:</span>
        chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      stderrLen <span class="token operator">+=</span> length<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stderrLen <span class="token operator">&gt;</span> options<span class="token punctuation">.</span>maxBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> truncatedLen <span class="token operator">=</span> options<span class="token punctuation">.</span>maxBuffer <span class="token operator">-</span> <span class="token punctuation">(</span>stderrLen <span class="token operator">-</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _stderr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> truncatedLen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ERR_CHILD_PROCESS_STDIO_MAXBUFFER</span><span class="token punctuation">(</span><span class="token string">'stderr'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        _stderr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  child<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> exithandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  child<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> errorhandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>7-4 child_process事件应用方法详解</strong>
本节我们进入到child_process源码的第三轮，彻底搞懂process的回调流程，也是child_process中最复杂的部分。同样，我们通过processOn图对流程进行梳理一遍：</p> <p><a href="https://www.processon.com/embed/60322abd079129248a48e0ec" target="_blank" rel="noopener noreferrer">点击查看【processon】<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在分析了上面流程后，我们先写一些测试代码以理解上面的流程。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'ls -al|grep node_modules'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>stdout<span class="token punctuation">,</span>stderr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'callback--------start'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'callback--------end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stdout data:'</span><span class="token punctuation">,</span>chunk<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stderr data:'</span><span class="token punctuation">,</span>chunk<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stderr close'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">exitCode</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'exit:'</span><span class="token punctuation">,</span>exitCode<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'close!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>7-5 高难度：深度解析child_process库spawn方法回调原理</strong>
这一章完全听的懵逼了。略过。。。。。。。</p> <p><strong>7-6 child_process库fork执行流程分析</strong>
略。。。。。。。</p> <p><strong>7-7 精化：Node多进程源码总结</strong></p> <ul><li><p>exec/execFile/spawn/fork的区别</p> <ul><li>exec: 原理是调用/bin/sh -c 执行我们传入的shell脚本，底层调用略execFile</li> <li>execFile：原理是直接执行我们传入的file和args，底层调用spawn创建和执行子进程，并建立略回调，一次性将所有的stdout和stderr结果返回</li> <li>spawn:原理是调用略internal/child_process,实例化略ChildProcess子进程对象，再调用child.spawn创建子进程并执行命令，底层是调用了child.)handle.spawn执行process_wrap中的spwan方法，执行过程是异步的，执行完毕后再通过PIPE进行单向数据通信，通信结束后子进程发起onexit回调，同时Socket会执行close回调。</li> <li>fork:原理是通过spawn创建子进程和执行命令，采用node执行命令，通过setupchannel创建IPC用于子进程和父进程之间的双向通信。</li></ul></li> <li><p>data/error/exit/close回调的区别</p> <ul><li>data：用于主进程读取数据过程中通过onStreamRead发起的回调</li> <li>error: 命令执行失败后发起的回调</li> <li>exit: 子进程关闭完成后发起的回调</li> <li>close：子进程所有Socket通信端口全部关闭后发起的回调</li> <li>stdout close/stderr close:特定的PIPE读取完成后调用onReadableStreamEnd关闭Socket时发起的回调。</li></ul></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/liugezhou/daydayup/edit/main//docs/web/04.md" target="_blank" rel="noopener noreferrer">错误反馈</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web/03.html" class="prev">
        03-脚手架核心流程开发
      </a></span> <span class="next"><a href="/web/05.html">
        05-脚手架创建项目流程设计和开发
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4690e35c.js" defer></script><script src="/assets/js/2.505fbce2.js" defer></script><script src="/assets/js/1.8644e8ec.js" defer></script><script src="/assets/js/68.fa3c4346.js" defer></script>
  </body>
</html>
