<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>06-脚手架项目和组件初始化开发 | 今日前端</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?4ef6dc604509807e9702b3851e114a74";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
      </script>
      </script>
    <script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1183508160150958" crossorigin="anonymous"></script>
    <meta name="description" content="脚手架项目和组件初始化开发">
    
    <link rel="preload" href="/assets/css/0.styles.ab222855.css" as="style"><link rel="preload" href="/assets/js/app.4690e35c.js" as="script"><link rel="preload" href="/assets/js/2.505fbce2.js" as="script"><link rel="preload" href="/assets/js/1.8644e8ec.js" as="script"><link rel="preload" href="/assets/js/70.9965b915.js" as="script"><link rel="prefetch" href="/assets/js/10.cab30127.js"><link rel="prefetch" href="/assets/js/11.dd4acf6f.js"><link rel="prefetch" href="/assets/js/12.30378d2b.js"><link rel="prefetch" href="/assets/js/13.52db13dd.js"><link rel="prefetch" href="/assets/js/14.b1e55c9a.js"><link rel="prefetch" href="/assets/js/15.397321e8.js"><link rel="prefetch" href="/assets/js/16.41ea9dc0.js"><link rel="prefetch" href="/assets/js/17.ae9bd38c.js"><link rel="prefetch" href="/assets/js/18.7f05db4f.js"><link rel="prefetch" href="/assets/js/19.e7419ed2.js"><link rel="prefetch" href="/assets/js/20.5de11ad9.js"><link rel="prefetch" href="/assets/js/21.d1e22ea1.js"><link rel="prefetch" href="/assets/js/22.72ada26c.js"><link rel="prefetch" href="/assets/js/23.c0a0b2d8.js"><link rel="prefetch" href="/assets/js/24.3e816b8b.js"><link rel="prefetch" href="/assets/js/25.3f733c03.js"><link rel="prefetch" href="/assets/js/26.db25a028.js"><link rel="prefetch" href="/assets/js/27.15ed1846.js"><link rel="prefetch" href="/assets/js/28.208ac68e.js"><link rel="prefetch" href="/assets/js/29.69d9bd33.js"><link rel="prefetch" href="/assets/js/3.7a4ab8e5.js"><link rel="prefetch" href="/assets/js/30.f039addb.js"><link rel="prefetch" href="/assets/js/31.b9fd445b.js"><link rel="prefetch" href="/assets/js/32.899591cb.js"><link rel="prefetch" href="/assets/js/33.f3808942.js"><link rel="prefetch" href="/assets/js/34.1c51bd04.js"><link rel="prefetch" href="/assets/js/35.5dec34de.js"><link rel="prefetch" href="/assets/js/36.08add187.js"><link rel="prefetch" href="/assets/js/37.5feb420b.js"><link rel="prefetch" href="/assets/js/38.afefe479.js"><link rel="prefetch" href="/assets/js/39.c9cdfded.js"><link rel="prefetch" href="/assets/js/4.0aef8d22.js"><link rel="prefetch" href="/assets/js/40.96b04497.js"><link rel="prefetch" href="/assets/js/41.04859dc6.js"><link rel="prefetch" href="/assets/js/42.3881136d.js"><link rel="prefetch" href="/assets/js/43.d142a153.js"><link rel="prefetch" href="/assets/js/44.5cb88048.js"><link rel="prefetch" href="/assets/js/45.3541cd11.js"><link rel="prefetch" href="/assets/js/46.e6c88c3b.js"><link rel="prefetch" href="/assets/js/47.3f992b97.js"><link rel="prefetch" href="/assets/js/48.5996b4fc.js"><link rel="prefetch" href="/assets/js/49.fea4d36b.js"><link rel="prefetch" href="/assets/js/5.baaddd77.js"><link rel="prefetch" href="/assets/js/50.4cd3422c.js"><link rel="prefetch" href="/assets/js/51.228fffda.js"><link rel="prefetch" href="/assets/js/52.92861e6c.js"><link rel="prefetch" href="/assets/js/53.b72d8ce0.js"><link rel="prefetch" href="/assets/js/54.c15c9cdc.js"><link rel="prefetch" href="/assets/js/55.9bc4f52b.js"><link rel="prefetch" href="/assets/js/56.947ab898.js"><link rel="prefetch" href="/assets/js/57.fa37cf58.js"><link rel="prefetch" href="/assets/js/58.d682c2a2.js"><link rel="prefetch" href="/assets/js/59.4499ef43.js"><link rel="prefetch" href="/assets/js/6.f5ab8614.js"><link rel="prefetch" href="/assets/js/60.aa57de27.js"><link rel="prefetch" href="/assets/js/61.5049d857.js"><link rel="prefetch" href="/assets/js/62.ec9a8087.js"><link rel="prefetch" href="/assets/js/63.38b9610d.js"><link rel="prefetch" href="/assets/js/64.0034d3be.js"><link rel="prefetch" href="/assets/js/65.5a44c8b1.js"><link rel="prefetch" href="/assets/js/66.ad0a55cb.js"><link rel="prefetch" href="/assets/js/67.ab2beac7.js"><link rel="prefetch" href="/assets/js/68.fa3c4346.js"><link rel="prefetch" href="/assets/js/69.4c304a67.js"><link rel="prefetch" href="/assets/js/7.62e43543.js"><link rel="prefetch" href="/assets/js/71.f5f8e219.js"><link rel="prefetch" href="/assets/js/72.afe95f75.js"><link rel="prefetch" href="/assets/js/73.55da3950.js"><link rel="prefetch" href="/assets/js/74.860ada40.js"><link rel="prefetch" href="/assets/js/75.66a003ea.js"><link rel="prefetch" href="/assets/js/76.886902cd.js"><link rel="prefetch" href="/assets/js/77.680b69b8.js"><link rel="prefetch" href="/assets/js/78.6440c559.js"><link rel="prefetch" href="/assets/js/79.4f3af818.js"><link rel="prefetch" href="/assets/js/80.b04f59cc.js"><link rel="prefetch" href="/assets/js/81.d4c4e4b3.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.03d43e08.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ab222855.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.ico" alt="今日前端" class="logo"> <span class="site-name can-hide">今日前端</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/daily/day30.html" class="nav-link">
  今日前端
</a></div><div class="nav-item"><a href="/github/before.html" class="nav-link">
  Github网站食用
</a></div><div class="nav-item"><a href="/web/before.html" class="nav-link">
  前端脚手架
</a></div><div class="nav-item"><a href="https://blog.liugezhou.online" target="_blank" rel="noopener noreferrer" class="nav-link external">
  他的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/liugezhou/daydayup" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/daily/day30.html" class="nav-link">
  今日前端
</a></div><div class="nav-item"><a href="/github/before.html" class="nav-link">
  Github网站食用
</a></div><div class="nav-item"><a href="/web/before.html" class="nav-link">
  前端脚手架
</a></div><div class="nav-item"><a href="https://blog.liugezhou.online" target="_blank" rel="noopener noreferrer" class="nav-link external">
  他的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/liugezhou/daydayup" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/web/before.html" class="sidebar-link">关于</a></li><li><a href="/web/00.html" class="sidebar-link">00-整体架构设计文档范本V0.1</a></li><li><a href="/web/01.html" class="sidebar-link">01-需求分析与架构设计</a></li><li><a href="/web/02.html" class="sidebar-link">02-脚手架架构设计和框架搭建</a></li><li><a href="/web/03.html" class="sidebar-link">03-脚手架核心流程开发</a></li><li><a href="/web/04.html" class="sidebar-link">04-脚手架命令注册和执行过程开发</a></li><li><a href="/web/05.html" class="sidebar-link">05-脚手架创建项目流程设计和开发</a></li><li><a href="/web/06.html" aria-current="page" class="active sidebar-link">06-脚手架项目和组件初始化开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/06.html#第一章-本周导学" class="sidebar-link">第一章：本周导学</a></li><li class="sidebar-sub-header"><a href="/web/06.html#第二章-脚手架安装模版功能架构设计" class="sidebar-link">第二章：脚手架安装模版功能架构设计</a></li><li class="sidebar-sub-header"><a href="/web/06.html#第三章-脚手架模板安装核心实现-ejs-库功能详解" class="sidebar-link">第三章 脚手架模板安装核心实现：ejs 库功能详解</a></li><li class="sidebar-sub-header"><a href="/web/06.html#第四章-脚手架项目模板安装功能开发" class="sidebar-link">第四章：脚手架项目模板安装功能开发</a></li><li class="sidebar-sub-header"><a href="/web/06.html#第五章-组件模板开发及脚手架组件初始化功能支持" class="sidebar-link">第五章 组件模板开发及脚手架组件初始化功能支持</a></li><li class="sidebar-sub-header"><a href="/web/06.html#第六章-脚手架自定义初始化项目模板功能开发" class="sidebar-link">第六章 脚手架自定义初始化项目模板功能开发</a></li><li class="sidebar-sub-header"><a href="/web/06.html#第七章-本周加餐-ejs-库源码解析-彻底搞懂模板动态渲染原理" class="sidebar-link">第七章 本周加餐：ejs 库源码解析 —— 彻底搞懂模板动态渲染原理</a></li><li class="sidebar-sub-header"><a href="/web/06.html#第八章-加餐-require源码解析-彻底搞懂-npm-模块加载原理" class="sidebar-link">第八章 加餐：require源码解析，彻底搞懂 npm 模块加载原理</a></li></ul></li><li><a href="/web/14.html" class="sidebar-link">14-服务端选型：磨刀不如砍柴功</a></li><li><a href="/web/15.html" class="sidebar-link">15-服务端 CI_CD：Github 自动化</a></li><li><a href="/web/16.html" class="sidebar-link">16-编辑器服务端API开发</a></li><li><a href="/web/17.html" class="sidebar-link">17-编辑器服务端调用第三方服务</a></li><li><a href="/web/28.html" class="sidebar-link">28-脚手架发布模块架构设计和核心流程开发</a></li><li><a href="/web/29.html" class="sidebar-link">29-脚手架发布模式git自动化流程开发</a></li><li><a href="/web/30.html" class="sidebar-link">30-脚手架发布模块云构建系统开发</a></li><li><a href="/web/31.html" class="sidebar-link">31-脚手架发布模块云发布功能开发</a></li><li><a href="/web/32.html" class="sidebar-link">32-脚手架组件发布功能开发</a></li><li><a href="/web/33.html" class="sidebar-link">33-组件平台开发</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="第一章-本周导学"><a href="#第一章-本周导学" class="header-anchor">#</a> 第一章：本周导学</h2> <p><strong>1-1 本周整体内容介绍和学习方法</strong></p> <ul><li>重点：脚手架安装 项目/组件  功能开发。</li> <li>技术栈：ejs模版渲染(项目模板安装)和glob文件筛选。</li> <li>加餐：ejs源码解析、require源码解析。</li></ul> <h2 id="第二章-脚手架安装模版功能架构设计"><a href="#第二章-脚手架安装模版功能架构设计" class="header-anchor">#</a> 第二章：脚手架安装模版功能架构设计</h2> <p><strong>2-1 脚手架安装项目模板架构设计</strong>
installTemplate</p> <p><strong>2-2 脚手架组件初始化架构设计</strong>
与项目大体过程没有改变。
tiny change：</p> <ul><li>文本提示名称</li> <li>项目名称format</li> <li>组件需要填写描述信息</li></ul> <h2 id="第三章-脚手架模板安装核心实现-ejs-库功能详解"><a href="#第三章-脚手架模板安装核心实现-ejs-库功能详解" class="header-anchor">#</a> 第三章 脚手架模板安装核心实现：ejs 库功能详解</h2> <p><strong>3-1 ejs模板引擎的三种基本用法</strong></p> <p>ejs主要用于模版渲染的。jsp、php是之前模版渲染的代表。ejs的实现与jsp非常类似。</p> <ul><li>ejs.compile(html,options)(data)</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token comment">//第一种方法</span>
<span class="token keyword">const</span> html <span class="token operator">=</span><span class="token string">'&lt;div&gt;&lt;%= user.name%&gt;&lt;/div&gt;'</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> data <span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'liugezhou'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> template <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span>options<span class="token punctuation">)</span> <span class="token comment">//// 返回一个用于解析html中模板的 function</span>

<span class="token keyword">const</span> compileTemplate <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>compileTemplate<span class="token punctuation">)</span>   <span class="token comment">//&lt;div&gt;liugezhou&lt;/div&gt;</span>

<span class="token comment">//第二种用法</span>
<span class="token keyword">const</span> renderTemplate <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span>data<span class="token punctuation">,</span>options<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>renderTemplate<span class="token punctuation">)</span>

<span class="token comment">//第三种用法</span>
<span class="token keyword">const</span> renderFile <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">renderFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'template.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span>options<span class="token punctuation">)</span>
renderFile<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><p><strong>3-2 ejs模板不同标签用法详解</strong></p> <ul><li>&lt;%   : ‘脚本’标签，用于流程控制，无输出。</li> <li>&lt;%= : 输出数据到模版(输出是转义Html标签)</li> <li>&lt;%- : 输出非转义的数据到模版 :如果数据是<div>liugehou</div>,那么输出的就是这样的格式。</li> <li>&lt;%# : 注释标签，不执行、不输出内容，但是会占空间。</li> <li>&lt;%_ : 删除前面空格空符</li> <li>-%&gt;: 删除紧随其后的换行符</li> <li>_%&gt;: 删除后面空格字符</li></ul> <p><strong>3-3 ejs模板几种特殊用法</strong></p> <p>本节主要介绍ejs另外比较常用的三个辅助功能</p> <ul><li>包含: include</li> <li>自定义分隔符: 我们上面默认使用的是%，我们只需要在options参数中定义 delimiter这个参数即可</li> <li>自定义文件加载器: 在使用ejs.renderFile读取文件之前，可以使用ejs.fileLoader做一些操作</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>ejs<span class="token punctuation">.</span><span class="token function-variable function">fileLoader</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token string">'&lt;div&gt;&lt;%= user.copyright %&gt;&lt;/div&gt;'</span> <span class="token operator">+</span> content
<span class="token punctuation">}</span>
</code></pre></div><p><strong>3-4 glob用法小结</strong></p> <p>glob最早是出现在类Unix系统的命令中的，用来匹配文件路径。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span>

<span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">'**/*.js'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">ignore</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'node_modules/**'</span><span class="token punctuation">,</span><span class="token string">'webpack.config.js'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>file</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="第四章-脚手架项目模板安装功能开发"><a href="#第四章-脚手架项目模板安装功能开发" class="header-anchor">#</a> 第四章：脚手架项目模板安装功能开发</h2> <p><strong>4-1 引入项目模板类型和标准安装逻辑开发</strong></p> <p>本节代码较少，主要是梳理流程，上一大周写到了下载模版到本地缓存，本节接着上周进度：
接着便需要安装模版，新建了安装模版 installTemplate()方法，并对拿到模版的type进行判断，
若为normal，则执行安装标准模版方法：installNormalTemplate()
若为custom，则执行安装自定义模版方法：installCustomTemplate()</p> <p><strong>4-2 拷贝项目模板功能开发</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token function">installNormalTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//拷贝模板代码至当前目录</span>
  <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">spinnerStart</span><span class="token punctuation">(</span><span class="token string">'正在安装模板...'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 去缓存目录中拿template下的文件路径</span>
    <span class="token keyword">const</span> templatePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>templateNpm<span class="token punctuation">.</span>cacheFilePath<span class="token punctuation">,</span><span class="token string">'template'</span><span class="token punctuation">)</span>
    <span class="token comment">//当前执行脚手架目录</span>
    <span class="token keyword">const</span> targetPath <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fse<span class="token punctuation">.</span><span class="token function">ensureDirSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">)</span><span class="token comment">//确保使用前缓存生成目录存在，若不存在则创建</span>
    fse<span class="token punctuation">.</span><span class="token function">ensureDirSync</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span>   <span class="token comment">//确保当前脚手架安装目录存在，若不存在则创建</span>
    fse<span class="token punctuation">.</span><span class="token function">copySync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span>targetPath<span class="token punctuation">)</span> <span class="token comment">//将缓存目录下文件copy至当前目录</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error
  <span class="token punctuation">}</span> <span class="token keyword">finally</span><span class="token punctuation">{</span> 
    spinner<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'模板安装成功'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>4-3 项目模板安装依赖和启动命令 | <strong>4-4 白名单命令检测功能开发</strong></strong></p> <p>在上一节，模板copy成功之后，紧接着：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//依赖安装</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> installCommand<span class="token punctuation">,</span>startCommand <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo
<span class="token comment">//依赖安装</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>installCommand<span class="token punctuation">,</span><span class="token string">'依赖过程安装失败！'</span><span class="token punctuation">)</span>
<span class="token comment">//启动命令执行</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>startCommand<span class="token punctuation">,</span><span class="token string">'启动命令执行失败失败！'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">WHITE_COMMAND</span> <span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'npm'</span><span class="token punctuation">,</span> <span class="token string">'cnpm'</span><span class="token punctuation">]</span> 

<span class="token keyword">async</span> <span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token parameter">command<span class="token punctuation">,</span>errMsg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> ret 
        <span class="token keyword">if</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> cmdArray<span class="token operator">=</span>command<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
            <span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkCommand</span><span class="token punctuation">(</span>cmdArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>cmd<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">const</span> args <span class="token operator">=</span> cmdArray<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            ret <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">execAsync</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span>args<span class="token punctuation">,</span><span class="token punctuation">{</span>
                <span class="token literal-property property">stdio</span><span class="token operator">:</span><span class="token string">'inherit'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">cwd</span><span class="token operator">:</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//执行成功</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'依赖安装过程失败'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> ret
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">checkCommand</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">WHITE_COMMAND</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> cmd
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>4-5 项目名称自动格式化功能开发</strong></p> <blockquote><p>本节使用了kebab-case这个库，将手动填入的项目名称保存在projectInfo中，以供后续package.json中的ejs渲染使用。</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//生成className</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>projectInfo<span class="token punctuation">.</span>projectName<span class="token punctuation">)</span><span class="token punctuation">{</span>
  projectInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> projectInfo<span class="token punctuation">.</span>projectName
  projectInfo<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'kebab-case'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>projectInfo<span class="token punctuation">.</span>projectName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^-</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>projectInfo<span class="token punctuation">.</span>projectVersion<span class="token punctuation">)</span><span class="token punctuation">{</span>
  projectInfo<span class="token punctuation">.</span>version <span class="token operator">=</span> projectInfo<span class="token punctuation">.</span>projectVersion
<span class="token punctuation">}</span>
</code></pre></div><p><strong>4-6 本章核心：ejs动态渲染项目模板</strong></p> <ul><li>首先将vue2模版中package.json文件中的name以及version使用&lt;%= className%&gt;和&lt;%= version%&gt;替代，并发布新的版本至npm。</li> <li>commands/init模块安装 ejs和glob库。</li> <li>核心代码如下(在4-4节中依赖安装前，ejs动态渲染)</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">async</span> <span class="token function">ejsRender</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> dir <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">const</span> projectInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectInfo
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">'**'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
       <span class="token literal-property property">cwd</span><span class="token operator">:</span>dir<span class="token punctuation">,</span>
       <span class="token literal-property property">ignore</span><span class="token operator">:</span>options<span class="token punctuation">.</span>ignore <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
       <span class="token literal-property property">nodir</span><span class="token operator">:</span><span class="token boolean">true</span>   <span class="token comment">//不输出文件夹，只输出文件</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
       Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
         <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>file<span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token parameter">resolve1<span class="token punctuation">,</span>reject1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           ejs<span class="token punctuation">.</span><span class="token function">renderFile</span><span class="token punctuation">(</span> filePath<span class="token punctuation">,</span>projectInfo<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
               <span class="token function">reject1</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
             <span class="token punctuation">}</span>
             fse<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span>result<span class="token punctuation">)</span>
             <span class="token function">resolve1</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
           <span class="token punctuation">}</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
         <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
</code></pre></div><p><strong>4-7 init命令直接传入项目名称功能支持</strong></p> <p>本节完成的是  对命令行中传入项目名称的一个支持
通过判断脚手架命令是否传入项目名称，对inquirer中的prompt进行动态push。</p> <h2 id="第五章-组件模板开发及脚手架组件初始化功能支持"><a href="#第五章-组件模板开发及脚手架组件初始化功能支持" class="header-anchor">#</a> 第五章 组件模板开发及脚手架组件初始化功能支持</h2> <p><strong>5-1 慕课乐高组件库模板开发</strong></p> <blockquote><p>维护组件库发布至npm，然后在mongodb数据库中进行配置。</p></blockquote> <p><strong>5-2 项目和组件模板数据隔离+动态配置ejs ignore</strong></p> <p>这部分完整代码如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token comment">//1.选取创建项目或组件</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">'list'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'type'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">message</span><span class="token operator">:</span><span class="token string">'请选择初始化类型'</span><span class="token punctuation">,</span> 
  <span class="token keyword">default</span><span class="token operator">:</span><span class="token constant">TYPE_PROJECT</span><span class="token punctuation">,</span>
  <span class="token literal-property property">choices</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'项目'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token constant">TYPE_PROJECT</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'组件'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token constant">TYPE_COMPONENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 数据隔离核心代码</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>template <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>template<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">template</span> <span class="token operator">=&gt;</span>template<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span> template<span class="token punctuation">.</span>tag<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> title <span class="token operator">=</span>  type <span class="token operator">===</span> <span class="token constant">TYPE_PROJECT</span> <span class="token operator">?</span> <span class="token string">'项目'</span><span class="token operator">:</span><span class="token string">'组件'</span>
<span class="token keyword">const</span> projectNamePrompt <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">'input'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'projectName'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">message</span><span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请输入</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">的名称</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token keyword">default</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token function-variable function">validate</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> done <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidName</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请输入合法的</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">名称</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">filter</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> v
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> projectPrompt <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProjectNameValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  projectPrompt<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>projectNamePrompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
projectPrompt<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">'input'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'projectVersion'</span><span class="token punctuation">,</span>
  <span class="token keyword">default</span><span class="token operator">:</span><span class="token string">'1.0.0'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">message</span><span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请输入</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">版本号</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function-variable function">validate</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> done <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Do async stuff</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>semver<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请输入合法的</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">版本号</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">filter</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>semver<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> semver<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> v
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">'list'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'projectTemplate'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">message</span><span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请选择</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">模板</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">choices</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTemplateChoice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>5-3 获取组件信息功能开发</strong></p> <p>完整核心代码如下,添加了 descriptionPrompt</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">TYPE_COMPONENT</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 获取组件的基本信息</span>
  <span class="token keyword">const</span> descriptionPrompt <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">'input'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'componentDescription'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span><span class="token string">'请输入组件描述信息'</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token function-variable function">validate</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> done <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>v<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">done</span><span class="token punctuation">(</span><span class="token string">'请输入组件描述信息'</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> 
        <span class="token punctuation">}</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  projectPrompt<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>descriptionPrompt<span class="token punctuation">)</span>
  <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span>projectPrompt<span class="token punctuation">)</span>
  projectInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>projectInfo<span class="token punctuation">,</span>
    type<span class="token punctuation">,</span>
    <span class="token operator">...</span>component
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

……
<span class="token keyword">if</span><span class="token punctuation">(</span>projectInfo<span class="token punctuation">.</span>componentDescription<span class="token punctuation">)</span><span class="token punctuation">{</span>
  projectInfo<span class="token punctuation">.</span>description <span class="token operator">=</span> projectInfo<span class="token punctuation">.</span>componentDescription
<span class="token punctuation">}</span>

</code></pre></div><p><strong>5-4 解决组件库初始化过程中各种工程问题</strong></p> <p>慕课乐高组件库，在发布到npm包时，安装出现问题，问题原因是 package.json中，需要将
&quot;files&quot;:['dist']  这行代码去除，这是因为files这里限定了上传发布到npm后只有dist这个目录。</p> <h2 id="第六章-脚手架自定义初始化项目模板功能开发"><a href="#第六章-脚手架自定义初始化项目模板功能开发" class="header-anchor">#</a> 第六章 脚手架自定义初始化项目模板功能开发</h2> <p><strong>6-1 自定义项目模板开发</strong></p> <ul><li>发布自定义模版 <a href="https://www.npmjs.com/package/liugezhou-cli-dev-template-custom-vue2" target="_blank" rel="noopener noreferrer">liugezhou-cli-dev-template-custom-vue2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>mongodb中配置自定义模版数据。</li></ul> <p><strong>6-2 自定义模板执行逻辑开发</strong> <strong>6-3 自定义模板上线</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token function">installCustomTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//查询自定义模版的入口文件</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>templateNpm<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> rootFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>templateNpm<span class="token punctuation">.</span><span class="token function">getRootFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>rootFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'开始执行自定义模板'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> templatePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>templateNpm<span class="token punctuation">.</span>cacheFilePath<span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">templateInfo</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo<span class="token punctuation">,</span>
        <span class="token literal-property property">projectInfo</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectInfo<span class="token punctuation">,</span>
        <span class="token literal-property property">sourcePath</span><span class="token operator">:</span> templatePath<span class="token punctuation">,</span>
        <span class="token literal-property property">targetPath</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">require('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rootFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
      <span class="token keyword">await</span> <span class="token function">execAsync</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token string">'-e'</span><span class="token punctuation">,</span> code<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">stdio</span><span class="token operator">:</span><span class="token string">'inherit'</span><span class="token punctuation">,</span><span class="token literal-property property">cwd</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      log<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'自定义模版安装成功'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'自定义模板入口文件不存在'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="第七章-本周加餐-ejs-库源码解析-彻底搞懂模板动态渲染原理"><a href="#第七章-本周加餐-ejs-库源码解析-彻底搞懂模板动态渲染原理" class="header-anchor">#</a> 第七章 本周加餐：ejs 库源码解析 —— 彻底搞懂模板动态渲染原理</h2> <p><strong>7-1 ejs.compile执行流程分析</strong>
ejs模版渲染的思路值得我们学习，于是我们就开始了了ejs的源码的学习。</p> <p><a href="https://www.processon.com/view/link/6041c047e401fd641ae13fc6" target="_blank" rel="noopener noreferrer">点击查看【processon】<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>本节内容较简单，我们打开webstore，从下面的代码开始调试（11行 打断点）</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token string">'&lt;div&gt;&lt;%= user.name %&gt;&lt;/div&gt;'</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">user</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'liugezhou'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> template <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span>options<span class="token punctuation">)</span>
<span class="token keyword">const</span> compiletemplate <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//ejs.js</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">compile</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> templ<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//我们的opts传进来的参数为空，暂不看此判断逻辑</span>
    ……
  <span class="token punctuation">}</span>
  templ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Template</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> templ<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>templ = new Template(template,opts)   我们继续进去源码，重要的有两点</p></blockquote> <ul><li>this.templateText = text</li> <li>this.regex = this.createRegex()</li></ul> <blockquote><p>下节开始 templ.compile()</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Template</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  opts <span class="token operator">=</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>templateText <span class="token operator">=</span> text<span class="token punctuation">;</span>    <span class="token comment">//⭐️⭐️⭐️</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>truncate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currentLine <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>source <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>client <span class="token operator">=</span> opts<span class="token punctuation">.</span>client <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>escapeFunction <span class="token operator">=</span> opts<span class="token punctuation">.</span>escape <span class="token operator">||</span> opts<span class="token punctuation">.</span>escapeFunction <span class="token operator">||</span> utils<span class="token punctuation">.</span>escapeXML<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>compileDebug <span class="token operator">=</span> opts<span class="token punctuation">.</span>compileDebug <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>opts<span class="token punctuation">.</span>debug<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>filename <span class="token operator">=</span> opts<span class="token punctuation">.</span>filename<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>openDelimiter <span class="token operator">=</span> opts<span class="token punctuation">.</span>openDelimiter <span class="token operator">||</span> exports<span class="token punctuation">.</span>openDelimiter <span class="token operator">||</span> _DEFAULT_OPEN_DELIMITER<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>closeDelimiter <span class="token operator">=</span> opts<span class="token punctuation">.</span>closeDelimiter <span class="token operator">||</span> exports<span class="token punctuation">.</span>closeDelimiter <span class="token operator">||</span> _DEFAULT_CLOSE_DELIMITER<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>delimiter <span class="token operator">=</span> opts<span class="token punctuation">.</span>delimiter <span class="token operator">||</span> exports<span class="token punctuation">.</span>delimiter <span class="token operator">||</span> _DEFAULT_DELIMITER<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>strict <span class="token operator">=</span> opts<span class="token punctuation">.</span>strict <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>context <span class="token operator">=</span> opts<span class="token punctuation">.</span>context<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>cache <span class="token operator">=</span> opts<span class="token punctuation">.</span>cache <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>rmWhitespace <span class="token operator">=</span> opts<span class="token punctuation">.</span>rmWhitespace<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>root <span class="token operator">=</span> opts<span class="token punctuation">.</span>root<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>includer <span class="token operator">=</span> opts<span class="token punctuation">.</span>includer<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>outputFunctionName <span class="token operator">=</span> opts<span class="token punctuation">.</span>outputFunctionName<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>localsName <span class="token operator">=</span> opts<span class="token punctuation">.</span>localsName <span class="token operator">||</span> exports<span class="token punctuation">.</span>localsName <span class="token operator">||</span> _DEFAULT_LOCALS_NAME<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>views <span class="token operator">=</span> opts<span class="token punctuation">.</span>views<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>async <span class="token operator">=</span> opts<span class="token punctuation">.</span>async<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>destructuredLocals <span class="token operator">=</span> opts<span class="token punctuation">.</span>destructuredLocals<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>legacyInclude <span class="token operator">=</span> <span class="token keyword">typeof</span> opts<span class="token punctuation">.</span>legacyInclude <span class="token operator">!=</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> <span class="token operator">!</span><span class="token operator">!</span>opts<span class="token punctuation">.</span>legacyInclude <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>strict<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span>_with <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span>_with <span class="token operator">=</span> <span class="token keyword">typeof</span> opts<span class="token punctuation">.</span>_with <span class="token operator">!=</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> opts<span class="token punctuation">.</span>_with <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>opts <span class="token operator">=</span> options<span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>regex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRegex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ⭐️⭐️⭐️：该方法是对ejs标识符号%与开始结尾符号&lt;&gt;，进行定制化操作</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>7-2 深入讲解ejs编译原理</strong></p> <blockquote><p>上一节我们看到了 return templet.compile()处，源代码如下</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token function-variable function">compile</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">var</span> src<span class="token punctuation">;</span>
    <span class="token keyword">var</span> fn<span class="token punctuation">;</span>
    <span class="token keyword">var</span> opts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">;</span>
    <span class="token keyword">var</span> prepended <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> appended <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> escapeFn <span class="token operator">=</span> opts<span class="token punctuation">.</span>escapeFunction<span class="token punctuation">;</span>
    <span class="token keyword">var</span> ctor<span class="token punctuation">;</span>
    <span class="token keyword">var</span> sanitizedFilename <span class="token operator">=</span> opts<span class="token punctuation">.</span>filename <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'undefined'</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//⭐️⭐️⭐️⭐️⭐️</span>
      prepended <span class="token operator">+=</span>
        <span class="token string">'  var __output = &quot;&quot;;\n'</span> <span class="token operator">+</span>
        <span class="token string">'  function __append(s) { if (s !== undefined &amp;&amp; s !== null) __output += s }\n'</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>outputFunctionName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prepended <span class="token operator">+=</span> <span class="token string">'  var '</span> <span class="token operator">+</span> opts<span class="token punctuation">.</span>outputFunctionName <span class="token operator">+</span> <span class="token string">' = __append;'</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>destructuredLocals <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>destructuredLocals<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> destructuring <span class="token operator">=</span> <span class="token string">'  var __locals = ('</span> <span class="token operator">+</span> opts<span class="token punctuation">.</span>localsName <span class="token operator">+</span> <span class="token string">' || {}),\n'</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opts<span class="token punctuation">.</span>destructuredLocals<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> name <span class="token operator">=</span> opts<span class="token punctuation">.</span>destructuredLocals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            destructuring <span class="token operator">+=</span> <span class="token string">',\n  '</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          destructuring <span class="token operator">+=</span> name <span class="token operator">+</span> <span class="token string">' = __locals.'</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        prepended <span class="token operator">+=</span> destructuring <span class="token operator">+</span> <span class="token string">';\n'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>_with <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prepended <span class="token operator">+=</span>  <span class="token string">'  with ('</span> <span class="token operator">+</span> opts<span class="token punctuation">.</span>localsName <span class="token operator">+</span> <span class="token string">' || {}) {'</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
        appended <span class="token operator">+=</span> <span class="token string">'  }'</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      appended <span class="token operator">+=</span> <span class="token string">'  return __output;'</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>source <span class="token operator">=</span> prepended <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source <span class="token operator">+</span> appended<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>compileDebug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      src <span class="token operator">=</span> <span class="token string">'var __line = 1'</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
        <span class="token operator">+</span> <span class="token string">'  , __lines = '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>templateText<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
        <span class="token operator">+</span> <span class="token string">'  , __filename = '</span> <span class="token operator">+</span> sanitizedFilename <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
        <span class="token operator">+</span> <span class="token string">'try {'</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
        <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source
        <span class="token operator">+</span> <span class="token string">'} catch (e) {'</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
        <span class="token operator">+</span> <span class="token string">'  rethrow(e, __lines, __filename, __line, escapeFn);'</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
        <span class="token operator">+</span> <span class="token string">'}'</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      src <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      src <span class="token operator">=</span> <span class="token string">'escapeFn = escapeFn || '</span> <span class="token operator">+</span> escapeFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>compileDebug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        src <span class="token operator">=</span> <span class="token string">'rethrow = rethrow || '</span> <span class="token operator">+</span> rethrow<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>strict<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      src <span class="token operator">=</span> <span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>compileDebug <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      src <span class="token operator">=</span> src <span class="token operator">+</span> <span class="token string">'\n'</span>
        <span class="token operator">+</span> <span class="token string">'//# sourceURL='</span> <span class="token operator">+</span> sanitizedFilename <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          ctor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'return (async function(){}).constructor;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">SyntaxError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'This environment does not support async/await'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctor <span class="token operator">=</span> Function<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ctor</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>localsName <span class="token operator">+</span> <span class="token string">', escapeFn, include, rethrow'</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// istanbul ignore else</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">SyntaxError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          e<span class="token punctuation">.</span>message <span class="token operator">+=</span> <span class="token string">' in '</span> <span class="token operator">+</span> opts<span class="token punctuation">.</span>filename<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        e<span class="token punctuation">.</span>message <span class="token operator">+=</span> <span class="token string">' while compiling ejs\n\n'</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>message <span class="token operator">+=</span> <span class="token string">'If the above error is not helpful, you may want to try EJS-Lint:\n'</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>message <span class="token operator">+=</span> <span class="token string">'https://github.com/RyanZim/EJS-Lint'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>opts<span class="token punctuation">.</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          e<span class="token punctuation">.</span>message <span class="token operator">+=</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
          e<span class="token punctuation">.</span>message <span class="token operator">+=</span> <span class="token string">'Or, if you meant to create an async function, pass `async: true` as an option.'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> returnedFn <span class="token operator">=</span> opts<span class="token punctuation">.</span>client <span class="token operator">?</span> <span class="token function-variable function">fn</span> <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> <span class="token function-variable function">include</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> includeData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> d <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">shallowCopy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>includeData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          d <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">shallowCopy</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> includeData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">includeFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>context<span class="token punctuation">,</span> <span class="token punctuation">[</span>data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> escapeFn<span class="token punctuation">,</span> include<span class="token punctuation">,</span> rethrow<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>filename <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Object<span class="token punctuation">.</span>defineProperty <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> filename <span class="token operator">=</span> opts<span class="token punctuation">.</span>filename<span class="token punctuation">;</span>
      <span class="token keyword">var</span> basename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>returnedFn<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> basename<span class="token punctuation">,</span>
          <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* ignore */</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> returnedFn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

</code></pre></div><p><strong>generateSource：（最终拿到结果this.source）</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token function-variable function">generateSource</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> opts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">;</span>


    <span class="token comment">// Slurp spaces and tabs before &lt;%_ and after _%&gt;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>templateText <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>templateText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[ \t]*&lt;%_</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">,</span> <span class="token string">'&lt;%_'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">_%&gt;[ \t]*</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">,</span> <span class="token string">'_%&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> matches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseTemplateText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//⭐️⭐️⭐️⭐️⭐️</span>
    <span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>delimiter<span class="token punctuation">;</span>
    <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>openDelimiter<span class="token punctuation">;</span>
    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>closeDelimiter<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>matches <span class="token operator">&amp;&amp;</span> matches<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      matches<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">line<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//⭐️⭐️⭐️⭐️⭐️</span>
        <span class="token keyword">var</span> closing<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> line<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>o <span class="token operator">+</span> d<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span>        <span class="token comment">// If it is a tag</span>
          <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>o <span class="token operator">+</span> d <span class="token operator">+</span> d<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// and is not escaped</span>
          closing <span class="token operator">=</span> matches<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>closing <span class="token operator">==</span> d <span class="token operator">+</span> c <span class="token operator">||</span> closing <span class="token operator">==</span> <span class="token string">'-'</span> <span class="token operator">+</span> d <span class="token operator">+</span> c <span class="token operator">||</span> closing <span class="token operator">==</span> <span class="token string">'_'</span> <span class="token operator">+</span> d <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Could not find matching close tag for &quot;'</span> <span class="token operator">+</span> line <span class="token operator">+</span> <span class="token string">'&quot;.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        self<span class="token punctuation">.</span><span class="token function">scanLine</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">////⭐️⭐️⭐️⭐️⭐️</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span><span class="token punctuation">,</span>

</code></pre></div><p><strong>7-3 动态生成Function+with用法讲解</strong></p> <p>上一节代码没有继续追踪，根据自己的源码一步一步调试，生一节调试到的代码为：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// ejs.js  line662</span>
fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ctor</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>localsName <span class="token operator">+</span> <span class="token string">', escapeFn, include, rethrow'</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>代码讲解：
const ctor = Function;
const fn = new ctor('a,b','console.log(a,b)')
fn(1,2)</p> <p>我们回到7-1节中基础代码，在options加入参数debug为true，控制台输出内容为：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> __line <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token punctuation">,</span> __lines <span class="token operator">=</span> <span class="token string">&quot;&lt;div&gt;&lt;%= user.name%&gt;&lt;/div&gt;&quot;</span>
  <span class="token punctuation">,</span> __filename <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> __output <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> __output <span class="token operator">+=</span> s <span class="token punctuation">}</span>
  <span class="token keyword">with</span> <span class="token punctuation">(</span>locals <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;div&gt;&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token function">escapeFn</span><span class="token punctuation">(</span> user<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/div&gt;&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> __output<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">rethrow</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> __lines<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __line<span class="token punctuation">,</span> escapeFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>通过代码，我们看到了‘with’，现在前端with的使用已经很不常见且不推荐使用了，这里简单了解下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">user</span><span class="token operator">:</span><span class="token punctuation">{</span>
  	<span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'liugezhou'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 

<span class="token keyword">with</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>name<span class="token punctuation">)</span>   
<span class="token punctuation">}</span>
</code></pre></div><p><strong>7-4 ejs compile函数执行流程分析</strong></p> <p>apply简要解释</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//通常调用   // 1 2 3</span>

<span class="token function">test</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span><span class="token string">'applt'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 2 3 4 </span>
<span class="token function">test</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span><span class="token string">'call'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>    <span class="token comment">// 2 3 4</span>
</code></pre></div><p><strong>7-5 ejs.render和renderFile原理讲解</strong></p> <p>ejs.render的代码执行流程为：</p> <ul><li>const renderTemplate = ejs.render(html,data,options)</li> <li>exports.render ==&gt; handleCache(opts, template)</li> <li>handleCache ==&gt;  return  exports.compile(template, options);</li> <li>handleCache(opts, template)(data)</li></ul> <p>renderFile的原理讲解</p> <blockquote><ol><li>const renderFile = ejs.renderFile(<strong>path</strong>.resolve(__dirname,'template.html'),data,options)</li> <li>exports.renderFile</li> <li>tryHandleCache(opts, data, cb)</li> <li>handleCache(options)(data)</li></ol></blockquote> <h2 id="第八章-加餐-require源码解析-彻底搞懂-npm-模块加载原理"><a href="#第八章-加餐-require源码解析-彻底搞懂-npm-模块加载原理" class="header-anchor">#</a> 第八章 加餐：require源码解析，彻底搞懂 npm 模块加载原理</h2> <p><strong>8-1 require源码执行流程分析</strong></p> <ul><li><strong>require使用场景</strong></li></ul> <p>**</p> <ul><li><p>加载模块类型</p> <ul><li>加载内置模块： require('fs')</li> <li>加载node_modules模块：require('ejs')</li> <li>加载本地模块：require('./utils')</li></ul></li> <li><p>支持加载文件</p> <ul><li>js</li> <li>json</li> <li>node</li> <li>mjs</li> <li>加载其它类型</li></ul></li> <li><p><strong>require执行流程</strong></p></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/6-1.2gu4krgoga40.webp" alt="6-1">
我们在调试这行代码的时候，在执行栈中可以看到，之前也执行了很多代码，这里的流程以及上面分析的使用场景，我们可以先引出一些思考：</p> <ul><li><p>CommonJS模块的加载流程</p></li> <li><p>require如何加载内置模块？   loadNativeModule</p></li> <li><p>require如何加载node_modules模块？</p></li> <li><p>require为什么会将非js/json/node文件视为js进行加载</p></li> <li><p>require源码</p></li></ul> <ol><li>我们从  require('./ejs')  这行代码在webStorm中开始调试。（点击step into ）</li> <li>打开 Scripts --&gt; no domain --&gt; internal --&gt; modules --&gt; cjs --&gt;  helpers.js</li> <li>return mod.require(path);   ----&gt; line of 77 [helpers.js]</li></ol> <p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/6-2.ai0pdvjiq4o.webp" alt="6-2"></p> <ol><li><p>这里的mod就是指Module对象，调试后每个字段含义为：</p> <ol><li>id：源码文件路径</li> <li>path:源码文件对应的文件夹,通过path.dirname(id)生成</li> <li>exports：模块输出的内容，默认为{}</li> <li>parent：父模块信息</li> <li>filename:源码文件路径</li> <li>loaded：是否已经加载完毕</li> <li>children：子模块对象集合</li> <li>paths：模块查询范围</li></ol></li> <li><p>继续step into到下一步，进去Module对象的require方法</p></li> <li><p>代码如下:   (校验参数为 string类型且不为空)</p></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">validateString</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_INVALID_ARG_VALUE</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span>
                                    <span class="token string">'must be a non-empty string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  requireDepth<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Module<span class="token punctuation">.</span><span class="token function">_load</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token comment">/* isMain */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    requireDepth<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><blockquote><ol start="5"><li>Module._load(id,this,false) :</li></ol></blockquote> <ul><li>id：传入的字符串</li> <li>this：Module对象</li> <li>isMain:flase表示加载的不是一个主模块</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Module<span class="token punctuation">.</span><span class="token function-variable function">_load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> relResolveCacheIdentifier<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Module._load REQUEST %s parent: %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> parent<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    relResolveCacheIdentifier <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parent<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\x00</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> filename <span class="token operator">=</span> relativeResolveCache<span class="token punctuation">[</span>relResolveCacheIdentifier<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filename <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> cachedModule <span class="token operator">=</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedModule <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateChildren</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> cachedModule<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cachedModule<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">delete</span> relativeResolveCache<span class="token punctuation">[</span>relResolveCacheIdentifier<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ✨✨✨ </span>
  <span class="token comment">// Module._resolveFilename是require.resolve()的核心实现，在lerna源码讲解时学过--&gt; Module._resolveLookupPaths()</span>
  <span class="token keyword">const</span> filename <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveFilename</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> cachedModule <span class="token operator">=</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedModule <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateChildren</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> cachedModule<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cachedModule<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//✨✨✨</span>
  <span class="token comment">// loadNativeModule 中 加载内置模块，进入该源码:通过NativeModule.map我们可以看到所有的内置模块</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token function">loadNativeModule</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> request<span class="token punctuation">,</span> experimentalModules<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mod <span class="token operator">&amp;&amp;</span> mod<span class="token punctuation">.</span>canBeRequiredByUsers<span class="token punctuation">)</span> <span class="token keyword">return</span> mod<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

  <span class="token comment">// 不是内置模块，new Module，其中children在new的时候完成</span>
  <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>mainModule <span class="token operator">=</span> module<span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    relativeResolveCache<span class="token punctuation">[</span>relResolveCacheIdentifier<span class="token punctuation">]</span> <span class="token operator">=</span> filename<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> threw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSourceMaps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        module<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">rekeySourceMap</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> err<span class="token punctuation">;</span> <span class="token comment">/* node-do-not-add-exception-line */</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 🌟🌟🌟：模块加载</span>
      module<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    threw <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>threw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> relativeResolveCache<span class="token punctuation">[</span>relResolveCacheIdentifier<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>8-2 require加载模块原理详解</strong></p> <p>上一节我们走到了Module._load(filename)</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'load %j for module %j'</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>loaded<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// this.filename为上一节new的时候定义的filename</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> filename<span class="token punctuation">;</span>
  
  <span class="token comment">// 从这个文件的文件目录开始查到，拿到所有的可能有node_modules的路径</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>paths <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_nodeModulePaths</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 拿到该文件名的后缀：进入该方法可以看到定义的加载的后缀名有四种：js json node mjs</span>
  <span class="token keyword">const</span> extension <span class="token operator">=</span> <span class="token function">findLongestRegisteredExtension</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// allow .mjs to be overridden</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.mjs'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.mjs'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_REQUIRE_ESM</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 这里就是require模块加载的真正逻辑，包含 js node json,源码内容见下</span>
  Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>experimentalModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ESMLoader <span class="token operator">=</span> asyncESM<span class="token punctuation">.</span>ESMLoader<span class="token punctuation">;</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">pathToFileURL</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> module <span class="token operator">=</span> ESMLoader<span class="token punctuation">.</span>moduleMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create module entry at load time to snapshot exports correctly</span>
    <span class="token keyword">const</span> exports <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token comment">// Called from cjs translator</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>module <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>module <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> kInstantiated<span class="token punctuation">)</span>
        module<span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">setExport</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">,</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Preemptively cache</span>
      <span class="token comment">// We use a function to defer promise creation for async hooks.</span>
      ESMLoader<span class="token punctuation">.</span>moduleMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
        url<span class="token punctuation">,</span>
        <span class="token comment">// Module job creation will start promises.</span>
        <span class="token comment">// We make it a function to lazily trigger those promises</span>
        <span class="token comment">// for async hooks compatibility.</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">ModuleJob</span><span class="token punctuation">(</span>ESMLoader<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
          <span class="token keyword">new</span> <span class="token class-name">ModuleWrap</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setExport</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">,</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* isMain */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* inspectBrk */</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>Module._extensions<a href="this,filename">extension</a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">readPackageScope</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Function require shouldn't be used in ES modules.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'module'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> parentPath <span class="token operator">=</span> module<span class="token punctuation">.</span>parent <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>filename<span class="token punctuation">;</span>
      <span class="token keyword">const</span> packageJsonPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_REQUIRE_ESM</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> parentPath<span class="token punctuation">,</span> packageJsonPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//content内容就是我们加载的ejs/index.js问的内容，这里返回一个字符串</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 拿到ejs.index.js中的内容，Module原型链上执行_compile,代码如下：</span>
  module<span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_compile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span>  moduleURL<span class="token punctuation">;</span>
  <span class="token keyword">let</span> redirects<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>manifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    moduleURL <span class="token operator">=</span> <span class="token function">pathToFileURL</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redirects <span class="token operator">=</span> manifest<span class="token punctuation">.</span><span class="token function">getRedirector</span><span class="token punctuation">(</span>moduleURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    manifest<span class="token punctuation">.</span><span class="token function">assertIntegrity</span><span class="token punctuation">(</span>moduleURL<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">maybeCacheSourceMap</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> compiledWrapper <span class="token operator">=</span> <span class="token function">wrapSafe</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> inspectorWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getOptionValue</span><span class="token punctuation">(</span><span class="token string">'--inspect-brk'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>_eval <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolvedArgv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// We enter the repl if we're not given a filename argument.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          resolvedArgv <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveFilename</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
          <span class="token comment">// We only expect this codepath to be reached in the case of a</span>
          <span class="token comment">// preloaded module (it will fail earlier with the main entry)</span>
          <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">ArrayIsArray</span><span class="token punctuation">(</span><span class="token function">getOptionValue</span><span class="token punctuation">(</span><span class="token string">'--require'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        resolvedArgv <span class="token operator">=</span> <span class="token string">'repl'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Set breakpoint on module start</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedArgv <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasPausedEntry <span class="token operator">&amp;&amp;</span> filename <span class="token operator">===</span> resolvedArgv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hasPausedEntry <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      inspectorWrapper <span class="token operator">=</span> <span class="token function">internalBinding</span><span class="token punctuation">(</span><span class="token string">'inspector'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>callAndPauseOnStart<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> require <span class="token operator">=</span> <span class="token function">makeRequireFunction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> redirects<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> result<span class="token punctuation">;</span>
  <span class="token keyword">const</span> exports <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token keyword">const</span> thisValue <span class="token operator">=</span> exports<span class="token punctuation">;</span>
  <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>requireDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> statCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inspectorWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token function">inspectorWrapper</span><span class="token punctuation">(</span>compiledWrapper<span class="token punctuation">,</span> thisValue<span class="token punctuation">,</span> exports<span class="token punctuation">,</span>
                              require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token function">compiledWrapper</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>thisValue<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span>
                                  filename<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  hasLoadedAnyUserCJSModule <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>requireDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> statCache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>8-3 require加载内置模块和四种文件类型原理</strong></p> <ol><li>加载内置模块：流程到 loadNativeModule结束。</li> <li>加载node_modules模块：通过 Module._resolveFilename(request, parent, isMain)找到路径。</li> <li>加载不存在模块：Module._resolveFilename中抛出异常。</li> <li>加载.js/.json/.node/mjs文件：Module._extensions['XXX' ]</li> <li>加载其它文件后缀名：默认按js执行</li></ol> <p><strong>8-4 require缓存机制解析和CommonJS加载主模块原理</strong></p> <p>连续加载两次同一个文件，require是如何处理的？
require的缓存机制，使得在第二次加载相同的文件时，不会再次执行源文件，直接从缓存中去拿。</p> <p>CommonJS加载主模块流程：</p> <ul><li>require('internal/modules/cjs/loader').Module.runMain(process.argv[1]);</li> <li>Module._load(main, null, true);</li> <li>module.load(filename);</li> <li>Module._extensions[extension](this, filename);</li> <li>module._compile(content, filename);</li></ul> <p>与require的区别为：isMain为true，parent为null</p> <p><strong>8-5 require原理总结和回顾</strong></p> <ul><li><code>relativeResolveCache[relResolveCacheIdentifier]</code>查询缓存路径</li> <li><code>Module._cache[filename]</code>查询缓存模块</li> <li><code>Module._resolveFilename</code>查询模块的真实路径</li> <li><code>Module._resolveFilename</code>查询模块的真实路径</li> <li><code>new Module</code>实例化 Module 对象</li> <li><code>module.load(filename)</code>加载模块</li> <li><code>findLongestRegisteredExtension</code>获取文件后缀</li> <li><code>Module._extensions[extension](this, filename)</code>解析模块并执行模块</li> <li><code>module._compile</code>编译模块代码</li> <li><code>compileFunction</code>将模块代码生成可执行函数</li> <li><code>exports, require, module, filename, dirname</code>生成入参</li> <li><code>compiledWrapper.call</code>执行模块函数</li> <li><code>return module.exports</code> 输出模块返回结果</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/liugezhou/daydayup/edit/main//docs/web/06.md" target="_blank" rel="noopener noreferrer">错误反馈</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web/05.html" class="prev">
        05-脚手架创建项目流程设计和开发
      </a></span> <span class="next"><a href="/web/14.html">
        14-服务端选型：磨刀不如砍柴功
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4690e35c.js" defer></script><script src="/assets/js/2.505fbce2.js" defer></script><script src="/assets/js/1.8644e8ec.js" defer></script><script src="/assets/js/70.9965b915.js" defer></script>
  </body>
</html>
